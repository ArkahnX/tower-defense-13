(function(e,t){function r(e,t,n){var r=[];for(var i in e)e[i][t]===n&&r.push(e[i]);return r}function s(e,t){return Math.floor(Math.random()*(t-e+1))+e}function o(){h=n.getElementById("canvas"),h.width=f*c,h.height=l*c,p=h.getContext("2d")}function u(){var e=0;for(var t=0;t<d.length;t++)e+=d[t].priority;var n=s(0,e-1);for(var t=0;t<d.length;t++){if(n<d[t].priority)return t;n-=d[t].priority}return!1}function a(e,t){var n=e%t;return(e-n)/t}function N(){var e=n.querySelectorAll(".container");for(var t=0;t<e.length;t++)A(e[t],"click",C)}function C(e){var t=this;t.hasClass("expensive")||(tile.css({"left":e.pageX-16,"top":e.pageY-40}).removeClass("hidden").addClass("drain"),whatToBuild=t.find("img").attr("src"),console.log("remove"),pt(T[whatToBuild].stats.cost))}function k(e){}function L(e){y.x=e.pageX-h.offsetLeft,y.y=e.pageY-h.offsetTop,y.x=a(y.x,c),y.y=a(y.y,c),E="black",B()&&P()?E="green":B()===null?E="blue":B()||(E="red")}function A(e,t,n){O(e,t,n),e.addEventListener(t,n,!0)}function O(e,t,n){e.removeEventListener(t,n)}function M(){var e=y.x*32,t=y.y*32,n=e+32,r=t+32;p.strokeStyle=E,p.lineWidth=2,p.strokeRect(e,t,32,32),p.strokeStyle="#FFF",p.strokeRect(e-2,t-2,36,36)}function _(){var e=["canBuild","isBuilding","building","mouse","money"],t="<li>",r="</li>",i="<pre>",s="</pre>",o=[];for(var u=0;u<e.length;u++)typeof this[e[u]]=="function"?o.push(e[u]+": "+i+JSON.stringify(this[e[u]]())+s):o.push(e[u]+": "+i+JSON.stringify(this[e[u]])+s);n.getElementById("stats")&&(n.getElementById("stats").innerHTML="<ul>"+t+o.join(r+t)+r+"</ul>")}function D(){var e=["money"],t="<li>",r="</li>",i="<code>",s="</code>",o=[];for(var u=0;u<e.length;u++)typeof this[e[u]]=="function"?o.push(e[u]+": "+i+JSON.stringify(this[e[u]]())+s):o.push(e[u]+": "+i+JSON.stringify(this[e[u]])+s);n.getElementById("data").innerHTML="<ul>"+t+o.join(r+t)+r+"</ul>"}function P(){return H()?!0:!1}function H(){return r(T,"name","scorpion")[0]}function B(){var e=v[y.y][y.x];if(m[y.y][y.x]!==0)return null;var t=r(b,"y",y.y);return t.length&&r(t,"x",y.x).length?!1:P()?H().is==="terrain"?!0:e.is==="path"?!0:H().is==="trap"&&e.is==="fast"?!0:!1:!0}function j(){n.getElementById("towers").innerHTML=""}function F(){n.getElementById("towers").children.length>0&&j();var e=[];for(var t=0;t<w.length;t++){var r=w[t],i="<span>"+r.name+"</span>",s="<span class='cost'>$"+r.cost+"</span>",o="<img src='"+r.image.src+"'>",u="<div class='container' title='"+r.is+": "+r.name+" ($"+r.cost+")"+"'>"+o+i+s+"</div>";e.push(""+u+"")}n.getElementById("towers").innerHTML=e.join(""),N()}function I(){menu.children().length>0&&j();for(var e in T){var t=T[e],n=$("<div class='container'></div>"),r=$("<span>"+t.name+"</span>"),i=$("<span class='cost'>$"+t.stats.cost+"</span>"),s=new Image;n.append(s),n.append(r),n.append(i),s.src=t.src,s.title=t.type+": "+t.name+" ($"+t.stats.cost+")",menu.append(n),applyClicks()}var o=$("#canvas").position().left,u=$("#canvas").position().top;target.css({"left":o-3,"top":u-3})}function q(e,t){var n=[],r=[];for(var i=0;i<t;i++){n[i]=n[i]||[],r[i]=r[i]||[];for(var o=0;o<e;o++){var a=u(),f=d[a];f.x=o,f.y=i,f.pos={"x":o,"y":i},n[i][o]=new X(d[a],"imageList"),r[i][o]=0}}var l=s(e/2-1,t/2+1);return r[l][l]=1,[n,r]}function R(){for(var e=0;e<v.length;e++)for(var t=0;t<v[e].length;t++)p.drawImage(v[e][t].image,t*32,e*32)}function U(){for(var e=0;e<v.length;e++)for(var t=0;t<v[e].length;t++)m[e][t]>0&&Z(w[m[e][t]-1].name,t,e)}function z(e,t,n,r,i,o,u){var a,f,l=[],c=[];for(var h=0;h<e;h++)l.push(s(0,t-1,e)),c.push(s(0,t-1,e));for(a=0;a<e;a++)f=s(n,r),p.fillStyle="rgb("+Math.floor(f/i)+","+Math.floor(f/o)+","+Math.floor(f/u)+")",p.fillRect(l[a],c[a],1,1)}function W(e,t,n,r,i,o){var u=[];h.width=32,h.height=32;for(var a=0;a<3;a++){num=s(i[0][1],i[0][2]),p.fillStyle="rgb("+Math.floor(num/i[0][3])+","+Math.floor(num/i[0][4])+","+Math.floor(num/i[0][5])+")",p.fillRect(0,0,o,o);for(var c=0;c<i.length;c++)z(i[c][0],o,i[c][1],i[c][2],i[c][3],i[c][4],i[c][5]);var d=new Image;d.src=h.toDataURL(),u.push(d),p.clearRect(0,0,h.width,h.height)}var v=g;return g++,h.width=f*o,h.height=l*o,{"name":e,"is":t,"imageList":u,"images":u.length,"priority":n,"id":v,"speed":r}}function X(e,t){for(var n in e)n===t?this.image=e[t][s(0,e.images-1)]:this[n]=e[n];return this}function V(){d.push(W("grass","path",7,2,[[1024,175,230,1.3,1,2],[50,200,245,1,1.3,1.5],[100,125,175,2,1,2]],32)),d.push(W("darkGrass","path",7,2,[[1024,150,205,1.3,1,2],[50,175,220,1,1.3,1.5],[100,100,150,2,1,2]],32)),d.push(W("road","speed",4,1,[[1024,0,0,1,1,1],[600,0,50,1,1,1]],32)),d.push(W("water","slow",3,3,[[1024,100,200,1.5,1.5,1],[600,100,200,1.5,1.5,1]],32))}function J(){requestAnimationFrame(J),K()}function K(){R(),M(),U(),ft(),_(),D()}function Q(){n.getElementById("loading").classList.add("hidden")}function G(){var e=[["base","special",1e3,100,15,25,255,0,0],["turret","basic",100,10,10,20,200,0,0]];for(var t=0;t<e.length;t++)w.push(Y(e[t][0],e[t][1],e[t][2],e[t][3],e[t][4],e[t][5],e[t][6],e[t][7],e[t][8]))}function Y(e,t,n,r,i,o,u,a,d){var v=s(i,o),m=s(i,o)+Math.floor(v/1.5),g=s(i-3,o-3);h.width=32,h.height=32,p.clearRect(0,0,h.width,h.height),rt(0,0,v,m,g,u,d,a);var y=new Image;return y.src=h.toDataURL(),h.width=f*c,h.height=l*c,{"name":e,"is":t,"cost":n,"health":r,"color":[u,d,a],"image":y,"width":v,"height":m,"depth":g}}function Z(e,t,n){var i=r(w,"name",e)[0];rt(c*t+(c/2-i.width/2),c*n-i.height+c/2,i.width,i.height,i.depth,i.color[0],i.color[1],i.color[2])}function et(e){return e-50<0?e:e-50}function tt(e,t,n,r,i,s,o){p.beginPath(),p.rect(e,t,n,r),p.fillStyle="rgb("+i+","+s+","+o+")",p.fill()}function nt(){var e=new Image;e.src=h.toDataURL(),images.push(e)}function rt(e,t,n,r,i,s,o,u){tt(e,t+i/2,n,r,s,u,o),tt(e,t,n,i,et(s),et(u),et(o))}function it(){for(var e=0;e<m.length;e++)for(var t=0;t<m[e].length;t++)if(m[e][t]===1)return{"x":t,"y":e};return!1}function st(){var e=[];b.push(ut("Scoot","normal","FF0000",12,13,125,e)),b.push(ut("Solly","normal","0FF000",18,8,200,e)),b.push(ut("Pyro","normal","00FF00",16,10,175,e)),b.push(ut("Demo","normal","000FF0",16,9,125,e)),b.push(ut("Hoovey","normal","0000FF",20,7,300,e)),b.push(ut("Engie","normal","FFFF00",16,10,125,e)),b.push(ut("Medic","normal","0FFFF0",14,11,150,e)),b.push(ut("Sniper","normal","00FFFF",12,10,125,e)),b.push(ut("Spah","normal","FFFFFF",10,10,125,e))}function ot(e,t,n){for(var r=0;r<n.length;r++)if(n[r][0]===e&&n[r][1]===t)return!1;return!0}function ut(e,t,n,r,i,o,u){var a=s(0,3),c=0,h=0;do if(a===0||a===2)c=s(0,f-1),a===2&&(h=f-1);else if(a===1||a===3)h=s(0,l-1),a===1&&(c=l-1);while(!ot(c,h,u));return u.push([c,h]),{"name":e,"type":t,"color":n,"size":r,"speed":i,"health":o,"x":c,"y":h,"path":at(c,h)}}function at(e,t,n,r){return lt.search(v,v[t][e],v[10][10])}function ft(){for(i=0;i<b.length;i++){var e=b[i];p.beginPath(),p.fillStyle=e.color,p.fillRect(e.x*c+c/2-e.size/2,e.y*c+c/2-e.size/2,e.size,e.size),p.fill()}}function ct(e){this.content=[],this.scoreFunction=e}function ht(e){x+=e,dt()}function pt(e){x-=e,dt()}function dt(){var e=n.querySelectorAll(".container");for(var t=0;t<e.length;t++){e[t].classList.remove("expensive");var r=e[t].querySelector(".cost").innerText.substring(1);parseInt(r,10)>x&&e[t].classList.add("expensive")}}var n=e.document;(function(){var t=0,n=["ms","moz","webkit","o"];for(var r=0;r<n.length&&!e.requestAnimationFrame;++r)e.requestAnimationFrame=e[n[r]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[r]+"CancelAnimationFrame"]||e[n[r]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(n,r){var i=(new Date).getTime(),s=Math.max(0,16-(i-t)),o=e.setTimeout(function(){n(i+s)},s);return t=i+s,o}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)})})(),e.addEventListener("DOMContentLoaded",function(){o(),V(),G(),F();var e=q(f,l);v=e[0],m=e[1],st(),J(),Q()});var f=20,l=20,c=32,h,p,d=[],v,m,g=0,y={"x":0,"y":0},b=[],w=[],E="black",S={"OPEN":1,"WALL":0},x=0,T={"images/drain.png":{"type":"trap","name":"drain","src":"images/drain.png","stats":{"health":"","cost":"10"}},"images/scorpion.png":{"type":"structure","name":"scorpion","src":"images/scorpion.png","stats":{"health":"100","cost":"100"}}};e.addEventListener("DOMContentLoaded",function(){A(h,"mousemove",L),A(h,"click",k)},!0),X.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},X.prototype.isWall=function(){return this.type==S.WALL};var lt={"init":function(e){for(var t=0,n=e.length;t<n;t++)for(var r=0,i=e[t].length;r<i;r++){var s=e[t][r];s.f=0,s.g=0,s.h=0,s.cost=s.speed,s.visited=!1,s.closed=!1,s.parent=null}},"heap":function(){return new ct(function(e){return e.f})},"search":function(e,t,n,r,i){lt.init(e),i=i||lt.manhattan,r=!!r;var s=lt.heap();s.push(t);while(s.size()>0){var o=s.pop();if(o===n){var u=o,a=[];while(u.parent)a.push(u),u=u.parent;return a.reverse()}o.closed=!0;var f=lt.neighbors(e,o,r);for(var l=0,c=f.length;l<c;l++){var h=f[l];if(h.closed||h.isWall())continue;var p=o.g+h.cost,d=h.visited;if(!d||p<h.g)h.visited=!0,h.parent=o,h.h=h.h||i(h.pos,n.pos),h.g=p,h.f=h.g+h.h,d?s.rescoreElement(h):s.push(h)}}return[]},"manhattan":function(e,t){var n=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return n+r},"neighbors":function(e,t,n){var r=[],i=t.x,s=t.y;return e[i-1]&&e[i-1][s]&&r.push(e[i-1][s]),e[i+1]&&e[i+1][s]&&r.push(e[i+1][s]),e[i]&&e[i][s-1]&&r.push(e[i][s-1]),e[i]&&e[i][s+1]&&r.push(e[i][s+1]),n&&(e[i-1]&&e[i-1][s-1]&&r.push(e[i-1][s-1]),e[i+1]&&e[i+1][s-1]&&r.push(e[i+1][s-1]),e[i-1]&&e[i-1][s+1]&&r.push(e[i-1][s+1]),e[i+1]&&e[i+1][s+1]&&r.push(e[i+1][s+1])),r}};ct.prototype={"push":function(e){this.content.push(e),this.sinkDown(this.content.length-1)},"pop":function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},"remove":function(e){var t=this.content.indexOf(e),n=this.content.pop();t!==this.content.length-1&&(this.content[t]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},"size":function(){return this.content.length},"rescoreElement":function(e){this.sinkDown(this.content.indexOf(e))},"sinkDown":function(e){var t=this.content[e];while(e>0){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},"bubbleUp":function(e){var t=this.content.length,n=this.content[e],r=this.scoreFunction(n);for(;;){var i=e+1<<1,s=i-1,o=null;if(s<t){var u=this.content[s],a=this.scoreFunction(u);a<r&&(o=s)}if(i<t){var f=this.content[i],l=this.scoreFunction(f);l<(o===null?r:a)&&(o=i)}if(o===null)break;this.content[e]=this.content[o],this.content[o]=n,e=o}}};var x=0})(window)