/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js*/

(function(t,n){function s(e,t){var n=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return n}function o(e,t){return Math.floor(Math.random()*(t-e+1))+e}function bt(e,t){var n;if(Array.isArray(e))for(n=0;n<e.length;n++)t.call(e[n],n);else for(n in e)e.hasOwnProperty(n)&&t.call(e[n],n)}function wt(e,t,n,r){return"rgba("+e+","+t+","+n+","+(r||1)+")"}function Et(e,t){u[V]=e,u[$]=t,a.clearRect(0,0,e,t)}function St(e,t,n,r){var i,s=Object.create(null);for(var o in e)t&&n?(i=t.indexOf(o),i>-1?s[o]=n[i](e,o,r):s[o]=e[o]):s[o]=e[o];return s}function xt(e){return e-50<0?0:e-50}function Tt(e){if(e)return e[g.x][g.y]}function Nt(e,t){e.health-=t}function Ct(e){return gt[it].round(e)}function kt(e){return gt[it][rt](e)}function Lt(e,t){return Ct(e*d+yt-t)}function At(e,t){return Ct(e*d+yt-t/2)}function Ot(){var e=0;for(var t=0;t<I[nt];t++)e+=I[t].priority;var n=o(0,e-1);for(var t=0;t<I[nt];t++){if(n<I[t].priority)return t;n-=I[t].priority}return!1}function Mt(e,t,n){var r=[];for(var i in e)e[i][t]===n&&r[st](e[i]);return r.length?r:!1}function _t(e,t){var n=e%t;return(e-n)/t}function Dt(e,t){return Math.random()*(t-e)+e}function Pt(e,t,n){return{"red":e,"green":t,"blue":n}}function Ht(e,t,n){return n?2*e*t+2*t*n+2*e*n:e*t}function Bt(){u=r[Z]("canvas"),u[V]=h*d,u[$]=p*d,a=u.getContext("2d"),M.push(function(e,t){a.drawImage(e.image,At(e.x,d),At(e.y,d))}),_.push(function(e,t){if(t!==0&&typeof t.weapon!="string"){a.beginPath();var n=At(t.x,1),r=At(t.y,1);a.arc(n,r,t.weapon.range*32,0,2*Math.PI,!1),a.fillStyle="rgba(255,255,255,0.2)",a.fill();var i=t.weapon.range*32-1,s=4*Math.PI,o=2*Math.PI;a.beginPath(),a.arc(n,r,i,s,o,!1),a.lineWidth=2,a.strokeStyle="rgba(0,0,0,0.2)",a.stroke()}}),D.push(function(e,t){t!==0&&(a.drawImage(t.image,At(t.x,t.width),Lt(t.y,t.height)),t.weapon.name&&Er(t))}),P.push(function(){hr(),Yn(),tr(),fn(),yr(),ln(),vr(),c++,T++,F[1]?r[Z]("nextWave").removeAttribute("disabled"):F[1]||r[Z]("nextWave").setAttribute("disabled",!0);if(!F[0].length&&!F[1]&&!R.length)Ft();else if(F[0].length&&c===120){c=0;for(var e=0;e<Ct(y/2);e++)nn()}else(c===600||E)&&F[1]&&(E&&(A++,E=!1),y++,F.splice(0,1),b=F[0].length,c=0)}),Nr("cannon",1,15,1,10,4,50,3,Pt(o(200,255),o(0,100),o(0,100)),function(e){return e}),Nr("spread",5,20,1,50,3,25,3,Pt(o(0,100),o(0,100),o(100,255)),function(e){return Dt(e-e/2,e+e/2)}),Nr("gatling",1,15,1,3,4,50,3,Pt(o(0,100),o(100,255),o(0,100)),function(e){return Dt(e-e/2,e+e/2)}),Nr("explode",25,120,5,50,5.5,35,3,Pt(o(0,100),o(100,255),o(100,255)),function(e){return Dt(-2,2)/60}),Nr("spike",1,10,1,15,1,15,2,Pt(o(100,255),o(0,100),o(100,255)),function(e){return Dt(e-e/2,e+e/2)}),j[st](vn("Base","none","special",1e6,1e3,[[10,15],[20,30],[10,15]],[Pt(225,0,0),Pt(xt(225),0,0)])),j[st](vn("Cannon","cannon","basic",50,10,[[10,15],[10,15],[5,10]],[Pt(200,0,0),Pt(xt(200),0,0)])),j[st](vn("Shotgun","spread","basic",250,10,[[15,20],[15,20],[10,15]],[Pt(125,0,0),Pt(xt(125),xt(125),0)])),j[st](vn("Explode","explode","basic",500,10,[[20,25],[20,25],[15,20]],[Pt(125,0,0),Pt(0,xt(125),xt(125))])),j[st](vn("Gatling","gatling","basic",1e3,10,[[25,30],[25,30],[20,25]],[Pt(125,0,0),Pt(0,0,125)])),j[st](vn("Spike","spike","trap",100,10,[[5,10],[5,10],[5,10]],[Pt(125,0,0),Pt(0,0,125)])),I.push(qt("grass",ct,7,1,Ut([[1024,175,230,1.3,1,2],[50,200,245,1,1.3,1.5],[100,125,175,2,1,2]]))),I.push(qt("darkGrass",ct,7,1,Ut([[1024,150,205,1.3,1,2],[50,175,220,1,1.3,1.5],[100,100,150,2,1,2]]))),I.push(qt("road","fast",4,.5,Ut([[1024,245,179,1.1,1.1,.8],[600,100,200,1,1,1.3]]))),I.push(qt("water","slow",3,1.5,Ut([[1024,100,200,1.5,1.5,1],[600,100,200,1.5,1.5,1]]))),I.push(qt("wall","wall",0,0,Ut([[1024,50,75,1.5,1.5,1],[600,0,50,1.5,1.5,1]]))),en(14),rn(13),b=F[0].length}function jt(){It(),r.getElementById("gameOver").classList.add("show")}function Ft(){It(),r.getElementById("gameWon").classList.add("show")}function It(){selectedStructure=null,ur=0,lr(),ur=0,bt(r.querySelectorAll(".timeLasted"),function(){this.textContent=Ct(T/60)}),bt(r.querySelectorAll(".towersBuilt"),function(){this.textContent=N}),bt(r.querySelectorAll(".towersUpgraded"),function(){this.textContent=C}),bt(r.querySelectorAll(".towersSold"),function(){this.textContent=k}),bt(r.querySelectorAll(".baseRepaired"),function(){this.textContent=L}),bt(r.querySelectorAll(".wavesCompleted"),function(){this.textContent=y-A}),bt(r.querySelectorAll(".moneySpent"),function(){this.textContent=O}),bt(r.querySelectorAll(".tryAgain"),function(){this.onclick=function(){t.location.reload()}})}function qt(e,t,n,r,i){var s=[];Et(32,32);var f=3;for(var l=0;l<f;l++){var c=o(i[0].fromColor,i[0].toColor);a.fillStyle=wt(Ct(c/i[0].redFactor),Ct(c/i[0].greenFactor),Ct(c/i[0].blueFactor)),a.fillRect(0,0,d,d);for(var m=0;m<i[nt];m++)Rt(i[m]);var g=new Image;g[ht]=u[at](),s[st](g),Et(h*d,p*d)}var y=v;return v++,u[V]=h*d,u[$]=p*d,{"name":e,"is":"terrain","type":t,"x":0,"y":0,"image":s,"images":s[nt],"priority":n,"id":y,"speed":r}}function Rt(e){var t,n,r=0,i=0;for(t=0;t<e.pixels;t++)r=o(0,d-1),i=o(0,d-1),n=o(e.fromColor,e.toColor),a.fillStyle=wt(Ct(n/e.redFactor),Ct(n/e.greenFactor),Ct(n/e.blueFactor)),a.fillRect(r,i,1,1)}function Ut(e){var t=[];for(var n=0;n<e.length;n++)t.push({"pixels":e[n][0],"fromColor":e[n][1],"toColor":e[n][2],"redFactor":e[n][3],"greenFactor":e[n][4],"blueFactor":e[n][5]});return t}function zt(e,t,n){return e[t][o(0,e.images-1)]}function Wt(e,t,n){return n[0]}function Xt(e,t,n){return n[1]}function Vt(e){Xn(e);var t=Ot(),n=St(I[o(0,1)],["image","x","y"],[zt,Wt,Xt],[g.x,g.y]);H[g.x][g.y]=n,R.length&&pn(R)}function $t(e){Xn(e);var t=Ot(),n=St(I[2],["image","x","y"],[zt,Wt,Xt],[g.x,g.y]);H[g.x][g.y]=n,R.length&&pn(R)}function Jt(e){Xn(e);var t=Ot(),n=St(I[3],["image","x","y"],[zt,Wt,Xt],[g.x,g.y]);H[g.x][g.y]=n,R.length&&pn(R)}function Kt(e){Xn(e);var t=Ot(),n=St(I[4],["image","x","y"],[zt,Wt,Xt],[g.x,g.y]);H[g.x][g.y]=n,R.length&&pn(R)}function Qt(e,t){for(var n=0;n<e;n++){H[n]=H[n]||[],B[n]=B[n]||[];for(var r=0;r<t;r++){var i=Ot(),s=St(I[i],["image","x","y"],[zt,Wt,Xt],[n,r]);H[n][r]=s,B[n][r]=0}}l=St(j[0]),l.x=kt(o(e/2-1,t/2+1)),l.y=kt(o(e/2-1,t/2+1)),B[l.x][l.y]=l}function Gt(){var e,t,n,r;for(e=0;e<H[nt];e++)for(t=0;t<H[e][nt];t++)for(n=0;n<M[nt];n++)M[n](H[e][t],B[e][t]);for(e=0;e<H[nt];e++)for(t=0;t<H[e][nt];t++)for(n=0;n<_[nt];n++)_[n](H[e][t],B[e][t]);for(e=0;e<H[nt];e++)for(t=0;t<H[e][nt];t++)for(n=0;n<D[nt];n++)D[n](H[e][t],B[e][t]);for(r=0;r<P[nt];r++)P[r]()}function Yt(e,t){var r=[];for(var i=0;i<h;i++){r[i]=r[i]||[];for(var s=0;s<p;s++){var o=St(I[H[i][s].id],["image","x","y"],[zt,Wt,Xt],[i,s]);B[i][s]&&B[i][s][X].toLowerCase()!=="base"&&(o.speed=0,B[i][s].type==="trap"&&(o.speed=.5)),r[i][s]=o}}return e!==n&&t!==n&&(r[e][t]=St(I[r[e][t].id],["image","x","y"],[zt,Wt,Xt],[e,t]),r[e][t].speed=0),r}function Zt(e){var t=[];for(var n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)if(n===0||n===e.length-1||r===0||r===e[n].length-1)if(e[n][r].speed!==0&&l){var i=Fn.search(e,e[n][r],e[l.x][l.y]);i.length&&t.push(!0)}else t.push(!1);return t}function en(e){for(var t=1;t<e+1;t++){var n=t/2,r=7;n*2>r&&(r=n*2),q.push({"level":t,"size":r,"speed":n*.5,"health":n*5,"fullHealth":n*5,"targetX":null,"targetY":null,"path":null,"x":null,"y":null,"pixelX":null,"pixelY":null,"pathIndex":0,"color":"rgb(0,0,0)","red":0,"green":0,"blue":0})}}function tn(e){var t,n=0;do{do{var r=0,i=0;if(side===0||side===2)r=o(0,h-1),side===2&&(i=h-1);else if(side===1||side===3)i=o(0,p-1),side===1&&(r=p-1);n++;var s=Yt()}while(s[r][i].speed===0);data.x=r,data.y=i,data.pixelX=At(r,data.size),data.pixelY=At(i,data.size),t=hn([data],s)}while(!t.length);return data.path=t,data.targetX=t[0].x,data.targetY=t[0].y,data.pathIndex=0,e}function nn(){if(F[0]&&l){var e=F[0].splice(0,1)[0];if(e){var t,n=0;do{do{var r=o(0,3),i=0,s=0;if(r===0||r===2)i=o(0,h-1),r===2&&(s=h-1);else if(r===1||r===3)s=o(0,p-1),r===1&&(i=p-1);n++;var u=Yt()}while(u[i][s].speed===0);e.x=i,e.y=s,e.pixelX=At(i,e.size),e.pixelY=At(s,e.size),t=hn([e],u)}while(!t.length);e.path=t,e.targetX=t[0].x,e.targetY=t[0].y,e.pathIndex=0,R.push(e)}}}function rn(e){for(var t=1;t<e+1;t++){var n=[];for(var r=t;r>0;r--)for(var i=0;i<r*2+15;i++){var s=St(q[t]);n.push(s)}F.push(n)}}function sn(e,t,n){return n[0]}function on(e,t,n){return n[1]}function un(e,t,n){return At(n[0],e.size)}function an(e,t,n){return At(n[1],e.size)}function fn(){bt(R,function(e){var t=this;if(t.health<1)cn(t,e);else{a.beginPath(),a.strokeStyle="white",a.lineWidth=2,a.strokeRect(t.pixelX,t.pixelY,t.size,t.size),a.fillStyle=t.color,a.fillRect(t.pixelX,t.pixelY,t.size,t.size),a.fill(),a.closePath();var n=15,r=t.fullHealth*100,i=t.health*100,s=(r-i)/(r/2)+1;i<r/2&&(s=(r/2-i)/(r/2));var o=s*Math.PI,u=1*Math.PI;a.beginPath(),a.arc(t.pixelX+t.size/2,t.pixelY+t.size/2,n,o,u,!1),a.lineWidth=2,a.strokeStyle="rgba(255,0,0,0.4)",a.stroke()}})}function ln(){bt(R,function(e){var t=this;if(l&&t.pathIndex<t[ct][nt]){var n=t[ct][t.pathIndex];t.x=_t(t.pixelX+t.size/2,d),t.y=_t(t.pixelY+t.size/2,d),t.targetX=n.x,t.targetY=n.y;var r=H[t.x][t.y],i=t[mt]/r[mt],s=At(t.targetX,t.size),o=At(t.targetY,t.size);Ct(t.pixelX)<s?t.pixelX+i>s?t.pixelX=s:t.pixelX+=i:Ct(t.pixelY)<o?t.pixelY+i>o?t.pixelY=o:t.pixelY+=i:Ct(t.pixelX)>s?t.pixelX-i<s?t.pixelX=s:t.pixelX-=i:Ct(t.pixelY)>o&&(t.pixelY-i<o?t.pixelY=o:t.pixelY-=i),Ct(t.pixelX)===At(t.targetX,t.size)&&Ct(t.pixelY)===At(t.targetY,t.size)&&t.pathIndex++}l&&t.x===l.x&&t.y===l.y&&(xn(t),cn(t,e,!0))})}function cn(e,t,n){var r=e.pixelX,i=e.pixelY,s=e.size/2;mr(kt(e.health/e.fullHealth*e.size)+1,60,[2,7],[-2,2,-2,2],[r,i-s,r+s,i+s],[wt(e.red,e.green,e.blue),wt(xt(e.red),xt(e.green),xt(e.blue))]),n||ar(e.fullHealth*10/y),R.splice(t,1)}function hn(e,t){if(l){var n=[],r,i,s;return bt(e,function(e){i=this,s=t||Yt(),r=Fn.search(s,s[i.x][i.y],s[l.x][l.y]),n[st](!!r.length)}),n.indexOf(!1)>-1?!1:r}}function pn(e){bt(e,function(e){var t=this,n=hn([t]);t.path=n,t.pathIndex=0,t.targetX=n[0].x,t.targetY=n[0].y})}function dn(){for(var e=0;e<F[0].length;e++)F[1].push(F[0][e]);E=!0}function vn(e,t,n,r,i,s,o){var u=mn(t,s,o);return{"is":"tower","name":e,"weapon":t,"width":u.width,"height":u.height,"depth":u.depth,"path":u.path,"colors":u.colors,"image":gn(u),"x":u.x,"y":u.y,"level":1,"type":n,"cost":r,"health":i,"fullHealth":i}}function mn(e,t,n){var r=o(t[0][0],t[0][1]),i=o(t[1][0],t[1][1]),s=o(t[2][0],t[2][1]),u="rectangle";return e!=="none"&&(u="triangle"),{"x":0,"y":0,"width":r,"height":i,"depth":s,"colors":n,"path":u}}function gn(e){var t=u[V],n=u[$];Et(e.width,e.height+e.depth),wn[e.path](e);var r=new Image;return r[ht]=u[at](),Et(t,n),r}function yn(e,t,n,r,i,s){a.beginPath(),a.rect(e,t,n,r),a.fillStyle=i,a.fill(),a.closePath()}function bn(e,t,n,r,i,s,o){a.beginPath(),a.moveTo(e,t),a.lineTo(i,s),a.lineTo(n,r),a.closePath(),a.fillStyle=o,a.fill(),a.closePath()}function En(){if(l!==null)return l;if(l===null){var e=Sn();if(e)return l=B[e.x][e.y],l}return!1}function Sn(){for(var e=0;e<B[nt];e++)for(var t=0;t<B[e][nt];t++)if(B[e][t][X]==="base")return{"x":e,"y":t};return!1}function xn(e){Nt(l,e.health);if(l.health<1){Tn(l.x,l.y),l=null;var t=En();t||jt()}}function Tn(e,t){var n=B[e][t],r=At(t,d),i=r-n.height/2,s=r+n.height,o=At(e,d),u=o+yt-n.width/2,a=o+n.width,f=[];for(var l=0;l<n.colors.length;l++){var c=n.colors[l];f.push(wt(c.red,c.green,c.blue))}mr(20,50,[2,7],[-2,2,-2,2],[u,i,a,s],f,!0),B[e][t]=0}function Nn(e,t){k++;var n=B[e][t],r=n.cost+n.cost*(n.level-1)*2*.25;ar(r),Tn(e,t)}function Cn(){var e=Hn().cost;m=null,ar(e)}function kn(e,t,n){return St(W[e.weapon])}function Ln(e,t){if(An()){C++;var n=B[e][t];fr(_n(n)),n.level++,Cr(n)}}function An(){return w&&ur>=_n(w)?!0:!1}function On(e,t){var n=B[e][t];ur<Dn(n)?(n.health+=ur/10,fr(ur)):ur>=Dn(n)&&(fr(Dn(n)),n.health=n.fullHealth),L++}function Mn(){return w&&ur>=Dn(w)?!0:!1}function _n(e){return e.cost*e.level*2}function Dn(e){return(e.fullHealth-e.health)*5}function Pn(){return Hn()?!0:!1}function Hn(){return m===ft?!1:Mt(j,X,m)[0]}function Bn(e){if(JSON.stringify(g)!==S||e){S=JSON.stringify(g),r.body.style.cursor="default";if(Tt(B)!==0)return r.body.style.cursor="pointer",x=null,ft;if(!Pn())return x=!0,!0;var t=Yt(g.x,g.y);if(Zt(t).indexOf(!0)===-1)return x=!1,!1;if(R[nt]){var t=Yt(g.x,g.y);if(!hn(R,t))return x=!1,!1}return Hn().is==="terrain"?(x=!0,!0):Hn().type==="trap"?Tt(H).type==="fast"||Tt(H).type==="slow"?(x=!0,!0):(x=!1,!1):Tt(H).type===ct?(x=!0,!0):(x=!1,!1)}return x}function jn(){r[Z](lt).children[nt]>0&&(r[Z](lt)[Y]="");var e=[];for(var t=1;t<j[nt];t++){var n=j[t],i="",s="",o=J+">"+n[X]+G,u=J+" class='cost'>$"+n.cost+G,a="<img src='"+n.image.src+"'>",f=K+" data-name='"+n.name+"' class='container"+i+s+"' title='"+n.type+": "+n[X]+" ($"+n.cost+")"+"'>"+a+o+u+Q;e.push(""+f+"")}r[Z](lt)[Y]=e.join(""),Wn()}function In(e){this.content=[],this.scoreFunction=e}function qn(){Rn(),f=requestAnimationFrame(qn)}function Rn(){Et(h*d,p*d),Gt()}function Un(){r[Z]("loadingText")[ut].add("hidden"),r[Z]("message")[ut].remove("hidden")}function zn(){r[Z]("loading")[ut].add("hidden"),qn()}function Wn(){var e=r[tt](".container");for(var t=0;t<e[nt];t++)Zn(e[t],"click",Vn)}function Xn(e){e.preventDefault()}function Vn(e){Xn(e);var t=this;!t[ut].contains("expensive")&&!Pn()&&(w=null,m=t.getAttribute("data-name"),fr(Mt(j,X,m)[0].cost))}function $n(e){Xn(e),(l.x!==g.x||l.y!==g.y)&&Nn(w.x,w.y),w=null}function Jn(e){Xn(e),(l.x!==g.x||l.y!==g.y)&&Ln(w.x,w.y)}function Kn(e){Xn(e),(l.x!==g.x||l.y!==g.y)&&On(w.x,w.y)}function Qn(e){Xn(e),w=null;if(Pn()&&Bn())if(e.which===2)Cn();else{N++;var t=St(Hn(),["x","y","weapon"],[Wt,Xt,kn],[g.x,g.y]);B[g.x][g.y]=t,w=B[g.x][g.y],m=null,lr(),R.length&&pn(R)}Bn()===null&&(e.which===2?(l.x!==g.x||l.y!==g.y)&&Nn(g.x,g.y):B[g.x][g.y]===0?w=null:w=B[g.x][g.y])}function Gn(e){g.x=e.pageX-u.offsetLeft,g.y=e.pageY-u.offsetTop,g.x=_t(g.x,d),g.y=_t(g.y,d)}function Yn(){strokeColor="black",Bn()&&Pn()?strokeColor="green":Bn()===ft?strokeColor="blue":Bn()||(strokeColor="red")}function Zn(e,t,n){er(e,t,n),e.addEventListener(t,n,!0)}function er(e,t,n){e.removeEventListener(t,n)}function tr(){var e=g.x*32,t=g.y*32;a.strokeStyle=strokeColor,a.lineWidth=2,a.strokeRect(e,t,32,32),a.strokeStyle="#FFF",a.strokeRect(e-2,t-2,36,36);if(w!==null){var e=w.x*32,t=w.y*32;a.strokeStyle="#FFF",a.lineWidth=2,a.strokeRect(e,t,32,32);if(typeof w.weapon!="string"){a.beginPath(),a.arc(At(w.x,1),At(w.y,1),w.weapon.range*32,0,2*Math.PI,!1),a.fillStyle="rgba(255,255,255,0.3)",a.fill();var n=w.weapon.range*32-1,r=4*Math.PI,i=2*Math.PI;a.beginPath(),a.arc(At(w.x,1),At(w.y,1),n,r,i,!1),a.lineWidth=2,a.strokeStyle="rgba(0,0,0,0.3)",a.stroke()}}}function nr(){Zn(r,"keydown",rr)}function rr(e){var t=0;(e.keyCode===65||e.keyCode===83||e.keyCode===68||e.keyCode===70)&&B[g.x][g.y]===0&&(e.keyCode===65&&ur>=100&&(fr(100),Vt(e)),e.keyCode===83&&ur>=100&&(fr(100),Jt(e)),e.keyCode===68&&ur>=100&&(fr(100),$t(e)),e.keyCode===70&&ur>=250&&(fr(250),Kt(e))),e.keyCode-48>=1&&e.keyCode-48<=5?t=e.keyCode-48:e.keyCode-96>=1&&e.keyCode-96<=5&&(t=e.keyCode-96),w&&(e.keyCode===81&&Kn(e),e.keyCode===87&&Jn(e),e.keyCode===69&&$n(e));if(t>0){Xn(e);var n=r[tt](".container"),i=n[t-1];!i[ut].contains("expensive")&&!Pn()&&(w=null,m=j[t].name,fr(Mt(j,X,m)[0].cost))}}function ir(){for(i=0;i<q[nt];i++){var t=q[i];for(e=0;e<t.path.length;e++){var n=t.path[e];a.beginPath(),a.fillStyle="rgba(100,100,100,0.5)",a.fillRect(n.x*d,n.y*d,d,d),a.fill(),a.closePath()}}}function sr(){for(i=0;i<q[nt];i++){var t=q[i],n=Yt(g.x,g.y),r=getBaseCoords(),s=Fn.search(n,n[t.x][t.y],n[r.x][r.y]);for(e=0;e<s.length;e++){var o=s[e];a.beginPath(),a.fillStyle="rgba(0,255,0,0.5)",a.fillRect(o.x*d,o.y*d,d,d),a.fill(),a.closePath()}}}function or(){cancelAnimationFrame(f)}function ar(e){ur+=Ct(e),lr()}function fr(e){ur-=Ct(e),O+=e,lr()}function lr(){var e=r[tt](".container");for(var t=0;t<e[nt];t++){var n=e[t],i=j[t+1];n[ut].remove("expensive"),n[ut].remove("building"),i.cost>ur&&n[ut].add("expensive"),Hn()&&n[ut].add("building")}cr()}function cr(){An()?r.getElementById("upgrade").setAttribute("disabled",!0):r.getElementById("upgrade").removeAttribute("disabled")}function hr(){var e=En().health||0,t="<li>",n="</li>",i="<code>",s="</code>",o=[];o[st]("Base Health: "+i+e+s),o[st]("Wave: "+i+y+s),o[st]("Enemies: "+i+b+s),o[st]("Enemies Remaining: "+i+(F[0].length+R.length)+s),o[st]("money: "+i+ur+s),r[Z]("data")[Y]="<ul>"+t+o.join(n+t)+n+"</ul>";var o=[];o[st]("Mouse Position: "+i+g.x+", "+g.y+s),o[st]("Tile: "+i+Tt(H).name+s),o[st]("Can Build: "+i+Bn()+s),r[Z]("selection")[Y]="<ul>"+t+o.join(n+t)+n+"</ul>";if(w!==null){var o=[];o.push("Name: "+i+w.name+s),o.push("Level: "+i+w.level+s),o.push("Health: "+i+w.health/w.fullHealth*100+"%"+s),o.push("Weapon Stats:"),o.push("Name: "+i+w.weapon.name+s),o.push("Range: "+i+w.weapon.range+s),o.push("Bullets Per Shot: "+i+w.weapon.amount+s),o.push("Delay: "+i+w.weapon.delay+s),o.push("Damage: "+i+w.weapon.damage+s),r[Z]("tower")[Y]="<ul>"+t+o.join(n+t)+n+"</ul>",pr(),w.name!=="Base"&&(r[Z]("sell").removeAttribute("disabled"),Zn(r[Z]("sell"),"click",$n),r[Z]("upgrade").value="Upgrade Tower ($"+_n(w)+")",An()&&(r[Z]("upgrade").removeAttribute("disabled"),Zn(r[Z]("upgrade"),"click",Jn))),w.health<w.fullHealth&&(r[Z]("repair").value="Repair Tower ($"+Dn(w)+")",r[Z]("repair").removeAttribute("disabled"),Zn(r[Z]("repair"),"click",Kn))}else pr();B[g.x][g.y]===0&&(Tt(H).type!=="wall"&&ur>=250&&(r[Z]("wallTile").removeAttribute("disabled"),Zn(r[Z]("wallTile"),"click",Kt)),Tt(H).type!=="normal"&&ur>=100&&(r[Z]("normalTile").removeAttribute("disabled"),Zn(r[Z]("normalTile"),"click",Vt)),Tt(H).type!=="slow"&&ur>=100&&(r[Z]("slowTile").removeAttribute("disabled"),Zn(r[Z]("slowTile"),"click",Jt)),Tt(H).type!=="fast"&&ur>=100&&(r[Z]("fastTile").removeAttribute("disabled"),Zn(r[Z]("fastTile"),"click",$t)))}function pr(){r[Z]("upgrade").value="Upgrade Tower",r[Z]("repair").value="Repair Tower",r[Z]("upgrade").setAttribute("disabled",!0),r[Z]("sell").setAttribute("disabled",!0),r[Z]("repair").setAttribute("disabled",!0),er(r[Z]("sell"),"click",$n),er(r[Z]("upgrade"),"click",Jn),er(r[Z]("repair"),"click",Kn),r[Z]("normalTile").setAttribute("disabled",!0),r[Z]("slowTile").setAttribute("disabled",!0),r[Z]("fastTile").setAttribute("disabled",!0),r[Z]("wallTile").setAttribute("disabled",!0),er(r[Z]("normalTile"),"click",Vt),er(r[Z]("slowTile"),"click",Jt),er(r[Z]("fastTile"),"click",$t),er(r[Z]("wallTile"),"click",Kt)}function dr(e,t,n,r,i,s,u,a,f,l,c,h){var p=i/3,v=d/60*o(i+p,i-p),m=o(0,h.length-1);return{"x":o(e,n),"y":o(t,r),"w":o(s,u),"h":o(s,u),"dx":Dt(a,f),"dy":Dt(l,c),"life":v,"lifespan":v,"color":h[m]}}function vr(){for(var e=0;e<U.length;e++){var t=U[e];a.beginPath(),a.fillStyle=t.color,a.fillRect(t.x,t.y,t.w,t.h),a.fill(),a.closePath(),t.life=t.life-1,t.life>0?(t.x=t.x+t.dx,t.y=t.y+t.dy):U.splice(e,1)}}function mr(e,t,n,r,i,s){for(var o=0;o<e;o++)U.push(dr(i[0],i[1],i[2],i[3],t,n[0],n[1],r[0],r[1],r[2],r[3],s))}function gr(e){var t=0,n=e.length;waitForParticles}function yr(){for(var e=0;e<z.length;e++){var t=z[e];if(t.x+t.radius>u.width||t.y+t.radius>u.height||t.x<0||t.y<0)z.splice(e,1);else{var n=Tr(t);if(n){z.splice(e,1),Nt(n,t.damage);var r=n.pixelX,i=n.pixelY,s=n.size/2;mr(kt(t.damage/n.fullHealth*n.size)+1,60,[2,7],[-2,2,-2,2],[r,i-s,r+s,i+s],[wt(n.red,n.green,n.blue),wt(xt(n.red),xt(n.green),xt(n.blue))])}else{a.beginPath(),a.fillStyle="rgba("+t.red+","+t.green+","+t.blue+","+t.life/t.maxLife+")",a.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),a.fill(),a.closePath();if(t.life>0||t.life<0)t.targetX>0&&t.targetY>0?(t.x-=t.speed*t.dx,t.y-=t.speed*t.dy):t.targetX<0&&t.targetY>0?(t.x-=t.speed*t.dx,t.y-=t.speed*t.dy):(t.x+=t.speed*t.dx,t.y+=t.speed*t.dy),t.life--;t.life===0&&z.splice(e,1)}}}}function br(e,t){var n=e.x-t.x,r=e.y-t.y;return n+r}function wr(e){if(e[0]){var t=e[0],n=br(l,e[0]);for(var r=1;r<e.length;r++)e[r]&&br(l,e[r])<n&&(t=e[r],n=br(l,e[r]));return t}return!1}function Er(e){if(e.weapon.timer>=e.weapon.delay){var t=[],n=At(e.x,1),r=At(e.y,1,e.size)-e.height,i=e.weapon.range*d;bt(R,function(e){var s=this;Sr(n,r,i,s.pixelX,s.pixelY,s.size/2)&&t.push(s)});if(e.weapon.timer>=e.weapon.delay){var s=wr(t);if(s){e.weapon.timer=0;var o=n-s.pixelX,u=r-s.pixelY,a=Math.atan(o/u),f=e.weapon.speed/60*Math.sin(a),l=e.weapon.speed/60*Math.cos(a),c=Math.sqrt(f*f+l*l)/(e.weapon.speed/2),h=s.speed*c;s.targetX>s.x?f+=h:s.targetX<s.x&&(f-=h),s.targetY>s.y?l+=h:s.targetY<s.y&&(l-=h),kr(e,n,r,f,l,o,u)}}}e.weapon.timer++}function Sr(e,t,n,r,i,s){var o=e-r,u=t-i,a=n+s;return o*o+u*u<=a*a}function xr(e,t,n,r,i,s,u,a,f,l,c,h,p,d,v){if(e==="cannon")z.push({"radius":i,"x":u,"y":a,"dx":f,"dy":l,"red":c,"green":h,"blue":p,"alpha":d,"life":r,"maxLife":r,"speed":s,"targetX":t,"targetY":n,"damage":v||1});else if(e==="spread")for(var m=0;m<5;m++){var c=o(0,100),h=o(0,100),p=o(100,255);xr("cannon",t,n,25,3,s,u,a,Dt(f-f/2,f+f/2),Dt(l-l/2,l+l/2),c,h,p,d,2)}else if(e==="beam")z.push({"radius":i,"x":u,"y":a,"dx":Dt(f-f/2,f+f/2),"dy":Dt(l-l/2,l+l/2),"red":c,"green":h,"blue":p,"alpha":d,"life":1e3,"maxLife":100,"speed":20,"targetX":t,"targetY":n,"damage":1});else if(e==="explode")for(var m=0;m<25;m++)z.push({"radius":i,"x":u,"y":a,"dx":Dt(-2,2)/60,"dy":Dt(-2,2)/60,"red":c,"green":h,"blue":p,"alpha":d,"life":35,"maxLife":35,"speed":120,"targetX":t,"targetY":n,"damage":5})}function Tr(e){for(var t=0;t<R.length;t++){var n=R[t];if(Sr(n.pixelX,n.pixelY,n.size/2,e.x,e.y,e.radius))return n}return!1}function Nr(e,t,n,r,i,s,o,u,a,f){W[e]={"name":e,"radius":u,"amount":t,"directionFunction":f,"x":null,"y":null,"dx":null,"dy":null,"level":1,"red":a.red,"green":a.green,"blue":a.blue,"alpha":1,"life":o,"maxLife":o,"speed":n,"targetX":null,"targetY":null,"range":s,"delay":i,"timer":0,"damage":r||1}}function Cr(e){if(e.level!==e.weapon.level){if(e.weapon.name==="spread"||e.weapon.name==="gatling"||e.weapon.name==="explode")var t=function(t){return t+e.level};else var t=function(e){return e};var n=function(e){return e};e.weapon=Lr(e.weapon,{"amount":t,"range":function(t){return t+e.level*.5},"life":function(t){return t+e.level*10},"maxLife":function(t){return t+e.level*10},"damage":function(t){return t+e.level},"delay":function(t){return t-e.level>-1?t-e.level:0},"speed":n})}}function kr(e,t,n,r,i,s,o){for(var u=0;u<e.weapon.amount;u++){var a=St(e.weapon);z.push(Lr(a,{"x":t,"y":n,"dx":e.weapon.directionFunction(r),"dy":e.weapon.directionFunction(i),"targetX":s,"targetY":o}))}}function Lr(e,t){for(var r in t)e[r]!==n&&(typeof t[r]=="function"?e[r]=t[r](W[e.name][r]):e[r]=t[r]);return e}var r=t.document,u,a,f=null,l=null,c=0,h=26,p=26,d=32,v=0,m=null,g={"x":0,"y":0},y=1,b=0,w=null,E=!1,S="",x=!0,T=0,N=0,C=0,k=0,L=0,A=0,O=0,M=[],_=[],D=[],P=[],H=[],B=[],j=[],F=[],I=[],j=[],q=[],R=[],U=[],z=[],W={},X="name",V="width",$="height",J="<span",K="<div",Q="</div>",G="</span>",Y="innerHTML",Z="getElementById",et="querySelector",tt=et+"All",nt="length",rt="floor",it="Math",st="push",ot="rgb(",ut="classList",at="toDataURL",ft=null,lt="towers",ct="path",ht="src",pt="cost",dt="next",vt="color",mt="speed",gt=t,yt=d/2;gt.addEventListener("DOMContentLoaded",function(){Bt(),jn(),Qt(h,p),ar(500),Zn(u,"mousemove",Gn),Zn(u,"mousedown",Qn),Zn(u,"contextmenu",Xn),Zn(r.getElementById("startGame"),"click",zn),Zn(r.getElementById("nextWave"),"click",dn),Zn(r.getElementById("nextWave"),"click",dn),Un(),nr()});var wn={"triangle":function(e){var t=e.x,n=e.y,r=e.depth,i=e.width,s=e.height,o=i/2,u=e.colors;bn(o+t,n,t,n+s,t+o,n+s+r,wt(u[0].red,u[0].green,u[0].blue)),bn(o+t-1,n,o+t-1,n+s+r,t+i,n+s,wt(u[1].red,u[1].green,u[1].blue))},"rectangle":function(e){var t=e.colors;yn(e.x,e.y+e.depth/2,e.width,e.height,wt(t[0].red,t[0].green,t[0].blue)),yn(e.x,e.y,e.width,e.depth,wt(t[1].red,t[1].green,t[1].blue))}},Fn={"init":function(e){for(var t=0,n=e[nt];t<n;t++)for(var r=0,i=e[t][nt];r<i;r++){var s=e[t][r];s.f=0,s.g=0,s.h=0,s[pt]=s[mt],s.visited=!1,s.closed=!1,s.parent=ft}},"heap":function(){return new In(function(e){return e.f})},"search":function(e,t,n){Fn.init(e),heuristic=Fn.manhattan;var r=Fn.heap();r[st](t);while(r.size()>0){var i=r.pop();if(i===n){var s=i,o=[];while(s.parent)o[st](s),s=s.parent;return o.reverse()}i.closed=!0;var u=Fn.neighbors(e,i);for(var a=0,f=u[nt];a<f;a++){var l=u[a];if(l.closed||l[mt]===0)continue;var c=i.g+l[pt],h=l.visited;if(!h||c<l.g)l.visited=!0,l.parent=i,l.h=l.h||heuristic(l.x,l.y,n.x,n.y),l.g=c,l.f=l.g+l.h,h?r.rescoreElement(l):r[st](l)}}return[]},"manhattan":function(e,t,n,r){var i=gt[it].abs(n-e),s=gt[it].abs(r-t);return i+s},"neighbors":function(e,t){var n=[],r=t.x,i=t.y;return e[r-1]&&e[r-1][i]&&n[st](e[r-1][i]),e[r+1]&&e[r+1][i]&&n[st](e[r+1][i]),e[r]&&e[r][i-1]&&n[st](e[r][i-1]),e[r]&&e[r][i+1]&&n[st](e[r][i+1]),n}};In.prototype={"push":function(e){this.content[st](e),this.sinkDown(this.content[nt]-1)},"pop":function(){var e=this.content[0],t=this.content.pop();return this.content[nt]>0&&(this.content[0]=t,this.bubbleUp(0)),e},"size":function(){return this.content[nt]},"rescoreElement":function(e){this.sinkDown(this.content.indexOf(e))},"sinkDown":function(e){var t=this.content[e];while(e>0){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},"bubbleUp":function(e){var t=this.content[nt],n=this.content[e],r=this.scoreFunction(n);for(;;){var i=e+1<<1,s=i-1,o=ft;if(s<t){var u=this.content[s],a=this.scoreFunction(u);a<r&&(o=s)}if(i<t){var f=this.content[i],l=this.scoreFunction(f);l<(o===ft?r:a)&&(o=i)}if(o===ft)break;this.content[e]=this.content[o],this.content[o]=n,e=o}}};var ur=0;(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t[nt]&&!gt.requestAnimationFrame;++n)gt.requestAnimationFrame=gt[t[n]+"RequestAnimationFrame"],gt.cancelAnimationFrame=gt[t[n]+"CancelAnimationFrame"]||gt[t[n]+"CancelRequestAnimationFrame"];gt.requestAnimationFrame||(gt.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=gt[it].max(0,16-(r-e)),s=gt.setTimeout(function(){t(r+i)},i);return e=r+i,s}),gt.cancelAnimationFrame||(gt.cancelAnimationFrame=function(e){clearTimeout(e)})})(),typeof r!="undefined"&&!("classList"in r.createElement("a"))&&function(e){"use strict";var t="classList",n="prototype",r=(e.HTMLElement||e.Element)[n],i=Object,s=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(e){var t=0,n=this.length;for(;t<n;t++)if(t in this&&this[t]===e)return t;return-1},u=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},a=function(e,t){if(t==="")throw new u("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new u("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(e,t)},f=function(e){var t=s.call(e.className),n=t?t.split(/\s+/):[],r=0,i=n.length;for(;r<i;r++)this.push(n[r]);this._updateClassName=function(){e.className=this.toString()}},l=f[n]=[],c=function(){return new f(this)};u[n]=Error[n],l.item=function(e){return this[e]||null},l.contains=function(e){return e+="",a(this,e)!==-1},l.add=function(e){e+="",a(this,e)===-1&&(this.push(e),this._updateClassName())},l.remove=function(e){e+="";var t=a(this,e);t!==-1&&(this.splice(t,1),this._updateClassName())},l.toggle=function(e){e+="",a(this,e)===-1?this.add(e):this.remove(e)},l.toString=function(){return this.join(" ")};if(i.defineProperty){var h={"get":c,"enumerable":!0,"configurable":!0};try{i.defineProperty(r,t,h)}catch(p){p.number===-2146823252&&(h.enumerable=!1,i.defineProperty(r,t,h))}}else i[n].__defineGetter__&&r.__defineGetter__(t,c)}(self);var Ar={}})(window)