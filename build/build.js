/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js*/

(function(t,n){function s(e,t){var n=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return n}function o(e,t){return Math.floor(Math.random()*(t-e+1))+e}function yt(e,t){var n;if(Array.isArray(e))for(n=0;n<e.length;n++)t.call(e[n],n);else for(n in e)e.hasOwnProperty(n)&&t.call(e[n],n)}function bt(e,t,n,r){return"rgba("+e+","+t+","+n+","+(r||1)+")"}function wt(e,t){u[X]=e,u[V]=t,a.clearRect(0,0,e,t)}function Et(e,t,n,r){var i,s=Object.create(null);for(var o in e)t&&n?(i=t.indexOf(o),i>-1?s[o]=n[i](e,o,r):s[o]=e[o]):s[o]=e[o];return s}function St(e){return e-50<0?0:e-50}function xt(e){if(e)return e[g.x][g.y]}function Tt(e,t){e.health-=t}function Nt(e){return mt[rt].round(e)}function Ct(e){return mt[rt][nt](e)}function kt(e,t){return Nt(e*d+gt-t)}function Lt(e,t){return Nt(e*d+gt-t/2)}function At(){var e=0;for(var t=0;t<F[tt];t++)e+=F[t].priority;var n=o(0,e-1);for(var t=0;t<F[tt];t++){if(n<F[t].priority)return t;n-=F[t].priority}return!1}function Ot(e,t,n){var r=[];for(var i in e)e[i][t]===n&&r[it](e[i]);return r.length?r:!1}function Mt(e,t){var n=e%t;return(e-n)/t}function _t(e,t){return Math.random()*(t-e)+e}function Dt(e,t,n){return{"red":e,"green":t,"blue":n}}function Pt(e,t,n){return n?2*e*t+2*t*n+2*e*n:e*t}function Ht(){u=r[Y]("canvas"),u[X]=h*d,u[V]=p*d,a=u.getContext("2d"),M.push(function(e,t){a.drawImage(e.image,Lt(e.x,d),Lt(e.y,d))}),_.push(function(e,t){if(t!==0){if(typeof t.weapon!="string"){a.beginPath();var n=Lt(t.x,1),r=Lt(t.y,1);a.arc(n,r,t.weapon.range*32,0,2*Math.PI,!1),a.fillStyle="rgba(255,255,255,0.2)",a.fill();var i=t.weapon.range*32-1,s=4*Math.PI,o=2*Math.PI;a.beginPath(),a.arc(n,r,i,s,o,!1),a.lineWidth=2,a.strokeStyle="rgba(0,0,0,0.2)",a.stroke()}a.drawImage(t.image,Lt(t.x,t.width),kt(t.y,t.height)),t.weapon.name&&vr(t)}}),D.push(function(){ur(),$n(),Qn(),rn(),hr(),sn(),fr(),c++,T++,j[1]?r[Y]("nextWave").removeAttribute("disabled"):j[1]||r[Y]("nextWave").setAttribute("disabled",!0);if(!j[0].length&&!j[1]&&!q.length)jt();else if(j[0].length&&c===120){c=0;for(var e=0;e<Nt(y/2);e++)Gt()}else(c===600||E)&&j[1]&&(E&&(A++,E=!1),y++,j.splice(0,1),b=j[0].length,c=0)}),br("cannon",1,15,1,10,4,50,3,Dt(o(200,255),o(0,100),o(0,100)),function(e){return e}),br("spread",5,20,1,50,3,25,3,Dt(o(0,100),o(0,100),o(100,255)),function(e){return _t(e-e/2,e+e/2)}),br("gatling",1,15,1,3,4,50,3,Dt(o(0,100),o(100,255),o(0,100)),function(e){return _t(e-e/2,e+e/2)}),br("explode",25,120,5,50,5.5,35,3,Dt(o(0,100),o(100,255),o(100,255)),function(e){return _t(-2,2)/60}),B[it](ln("Base","none","special",1e6,1e3,[[10,15],[20,30],[10,15]],[Dt(225,0,0),Dt(St(225),0,0)])),B[it](ln("Cannon","cannon","basic",50,10,[[10,15],[10,15],[5,10]],[Dt(200,0,0),Dt(St(200),0,0)])),B[it](ln("Shotgun","spread","basic",250,10,[[15,20],[15,20],[10,15]],[Dt(125,0,0),Dt(St(125),St(125),0)])),B[it](ln("Explode","explode","basic",500,10,[[20,25],[20,25],[15,20]],[Dt(125,0,0),Dt(0,St(125),St(125))])),B[it](ln("Gatling","gatling","basic",1e3,10,[[25,30],[25,30],[20,25]],[Dt(125,0,0),Dt(0,0,125)])),F.push(It("grass",lt,7,1,Rt([[1024,175,230,1.3,1,2],[50,200,245,1,1.3,1.5],[100,125,175,2,1,2]]))),F.push(It("darkGrass",lt,7,1,Rt([[1024,150,205,1.3,1,2],[50,175,220,1,1.3,1.5],[100,100,150,2,1,2]]))),F.push(It("road","fast",4,.5,Rt([[1024,0,0,1,1,1],[600,0,50,1,1,1]]))),F.push(It("water","slow",3,1.5,Rt([[1024,100,200,1.5,1.5,1],[600,100,200,1.5,1.5,1]]))),Kt(13),Yt(13),b=j[0].length}function Bt(){Ft(),r.getElementById("gameOver").classList.add("show")}function jt(){Ft(),r.getElementById("gameWon").classList.add("show")}function Ft(){selectedStructure=null,nr=0,sr(),nr=0,yt(r.querySelectorAll(".timeLasted"),function(){this.textContent=Nt(T/60)}),yt(r.querySelectorAll(".towersBuilt"),function(){this.textContent=N}),yt(r.querySelectorAll(".towersUpgraded"),function(){this.textContent=C}),yt(r.querySelectorAll(".towersSold"),function(){this.textContent=k}),yt(r.querySelectorAll(".baseRepaired"),function(){this.textContent=L}),yt(r.querySelectorAll(".wavesCompleted"),function(){this.textContent=y-A}),yt(r.querySelectorAll(".moneySpent"),function(){this.textContent=O}),yt(r.querySelectorAll(".tryAgain"),function(){this.onclick=function(){t.location.reload()}})}function It(e,t,n,r,i){var s=[];wt(32,32);var f=3;for(var l=0;l<f;l++){var c=o(i[0].fromColor,i[0].toColor);a.fillStyle=bt(Nt(c/i[0].redFactor),Nt(c/i[0].greenFactor),Nt(c/i[0].blueFactor)),a.fillRect(0,0,d,d);for(var m=0;m<i[tt];m++)qt(i[m]);var g=new Image;g[ct]=u[ut](),s[it](g),wt(h*d,p*d)}var y=v;return v++,u[X]=h*d,u[V]=p*d,{"name":e,"is":"terrain","type":t,"x":0,"y":0,"image":s,"images":s[tt],"priority":n,"id":y,"speed":r}}function qt(e){var t,n,r=0,i=0;for(t=0;t<e.pixels;t++)r=o(0,d-1),i=o(0,d-1),n=o(e.fromColor,e.toColor),a.fillStyle=bt(Nt(n/e.redFactor),Nt(n/e.greenFactor),Nt(n/e.blueFactor)),a.fillRect(r,i,1,1)}function Rt(e){var t=[];for(var n=0;n<e.length;n++)t.push({"pixels":e[n][0],"fromColor":e[n][1],"toColor":e[n][2],"redFactor":e[n][3],"greenFactor":e[n][4],"blueFactor":e[n][5]});return t}function Ut(e,t,n){return e[t][o(0,e.images-1)]}function zt(e,t,n){return n[0]}function Wt(e,t,n){return n[1]}function Xt(e,t){for(var n=0;n<e;n++){P[n]=P[n]||[],H[n]=H[n]||[];for(var r=0;r<t;r++){var i=At(),s=Et(F[i],["image","x","y"],[Ut,zt,Wt],[n,r]);P[n][r]=s,H[n][r]=0}}l=Et(B[0]),l.x=Ct(o(e/2-1,t/2+1)),l.y=Ct(o(e/2-1,t/2+1)),H[l.x][l.y]=l}function Vt(){var e,t,n,r;for(e=0;e<P[tt];e++)for(t=0;t<P[e][tt];t++)for(n=0;n<M[tt];n++)M[n](P[e][t],H[e][t]);for(e=0;e<P[tt];e++)for(t=0;t<P[e][tt];t++)for(n=0;n<_[tt];n++)_[n](P[e][t],H[e][t]);for(r=0;r<D[tt];r++)D[r]()}function $t(e,t){var r=[];for(var i=0;i<h;i++){r[i]=r[i]||[];for(var s=0;s<p;s++){var o=Et(F[P[i][s].id],["image","x","y"],[Ut,zt,Wt],[i,s]);H[i][s]&&H[i][s][W].toLowerCase()!=="base"&&(o.speed=0),r[i][s]=o}}return e!==n&&t!==n&&(r[e][t]=Et(F[r[e][t].id],["image","x","y"],[Ut,zt,Wt],[e,t]),r[e][t].speed=0),r}function Jt(e){var t=[];for(var n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)if(n===0||n===e.length-1||r===0||r===e[n].length-1)if(e[n][r].speed!==0&&l){var i=Dn.search(e,e[n][r],e[l.x][l.y]);i.length&&t.push(!0)}else t.push(!1);return t}function Kt(e){for(var t=1;t<e+1;t++){var n=t/2,r=7;n*2>r&&(r=n*2),I.push({"level":t,"size":r,"speed":n*.5,"health":n*5,"fullHealth":n*5,"targetX":null,"targetY":null,"path":null,"x":null,"y":null,"pixelX":null,"pixelY":null,"pathIndex":0,"color":"rgb(0,0,0)","red":0,"green":0,"blue":0})}}function Qt(e){var t,n=0;do{do{var r=0,i=0;if(side===0||side===2)r=o(0,h-1),side===2&&(i=h-1);else if(side===1||side===3)i=o(0,p-1),side===1&&(r=p-1);n++;var s=$t()}while(s[r][i].speed===0);data.x=r,data.y=i,data.pixelX=Lt(r,data.size),data.pixelY=Lt(i,data.size),t=un([data],s)}while(!t.length);return data.path=t,data.targetX=t[0].x,data.targetY=t[0].y,data.pathIndex=0,e}function Gt(){if(j[0]&&l){var e=j[0].splice(0,1)[0],t,n=0;do{do{var r=o(0,3),i=0,s=0;if(r===0||r===2)i=o(0,h-1),r===2&&(s=h-1);else if(r===1||r===3)s=o(0,p-1),r===1&&(i=p-1);n++;var u=$t()}while(u[i][s].speed===0);e.x=i,e.y=s,e.pixelX=Lt(i,e.size),e.pixelY=Lt(s,e.size),t=un([e],u)}while(!t.length);e.path=t,e.targetX=t[0].x,e.targetY=t[0].y,e.pathIndex=0,q.push(e)}}function Yt(e){for(var t=1;t<e+1;t++){var n=[];for(var r=t;r>0;r--)for(var i=0;i<r*2+15;i++){var s=Et(I[t]);n.push(s)}j.push(n)}}function Zt(e,t,n){return n[0]}function en(e,t,n){return n[1]}function tn(e,t,n){return Lt(n[0],e.size)}function nn(e,t,n){return Lt(n[1],e.size)}function rn(){yt(q,function(e){var t=this;if(t.health<1)on(t,e);else{a.beginPath(),a.strokeStyle="white",a.lineWidth=2,a.strokeRect(t.pixelX,t.pixelY,t.size,t.size),a.fillStyle=t.color,a.fillRect(t.pixelX,t.pixelY,t.size,t.size),a.fill(),a.closePath();var n=15,r=t.fullHealth*100,i=t.health*100,s=(r-i)/(r/2)+1;i<r/2&&(s=(r/2-i)/(r/2));var o=s*Math.PI,u=1*Math.PI;a.beginPath(),a.arc(t.pixelX+t.size/2,t.pixelY+t.size/2,n,o,u,!1),a.lineWidth=2,a.strokeStyle="rgba(255,0,0,0.4)",a.stroke()}})}function sn(){yt(q,function(e){var t=this;if(l&&t.pathIndex<t[lt][tt]){var n=t[lt][t.pathIndex];t.x=Mt(t.pixelX+t.size/2,d),t.y=Mt(t.pixelY+t.size/2,d),t.targetX=n.x,t.targetY=n.y;var r=P[t.x][t.y],i=t[vt]/r[vt],s=Lt(t.targetX,t.size),o=Lt(t.targetY,t.size);Nt(t.pixelX)<s?t.pixelX+i>s?t.pixelX=s:t.pixelX+=i:Nt(t.pixelY)<o?t.pixelY+i>o?t.pixelY=o:t.pixelY+=i:Nt(t.pixelX)>s?t.pixelX-i<s?t.pixelX=s:t.pixelX-=i:Nt(t.pixelY)>o&&(t.pixelY-i<o?t.pixelY=o:t.pixelY-=i),Nt(t.pixelX)===Lt(t.targetX,t.size)&&Nt(t.pixelY)===Lt(t.targetY,t.size)&&t.pathIndex++}l&&t.x===l.x&&t.y===l.y&&(yn(t),on(t,e,!0))})}function on(e,t,n){var r=e.pixelX,i=e.pixelY,s=e.size/2;lr(Ct(e.health/e.fullHealth*e.size)+1,60,[2,7],[-2,2,-2,2],[r,i-s,r+s,i+s],[bt(e.red,e.green,e.blue),bt(St(e.red),St(e.green),St(e.blue))]),n||rr(e.fullHealth*10/y),q.splice(t,1)}function un(e,t){if(l){var n=[],r,i,s;return yt(e,function(e){i=this,s=t||$t(),r=Dn.search(s,s[i.x][i.y],s[l.x][l.y]),n[it](!!r.length)}),n.indexOf(!1)>-1?!1:r}}function an(e){yt(e,function(e){var t=this,n=un([t]);t.path=n,t.pathIndex=0,t.targetX=n[0].x,t.targetY=n[0].y})}function fn(){E=!0;for(var e=0;e<j[0].length;e++)j[1].push(j[0][e])}function ln(e,t,n,r,i,s,o){var u=cn(t,s,o);return{"is":"tower","name":e,"weapon":t,"width":u.width,"height":u.height,"depth":u.depth,"path":u.path,"colors":u.colors,"image":hn(u),"x":u.x,"y":u.y,"level":1,"type":n,"cost":r,"health":i,"fullHealth":i}}function cn(e,t,n){var r=o(t[0][0],t[0][1]),i=o(t[1][0],t[1][1]),s=o(t[2][0],t[2][1]),u="rectangle";return e!=="none"&&(u="triangle"),{"x":0,"y":0,"width":r,"height":i,"depth":s,"colors":n,"path":u}}function hn(e){var t=u[X],n=u[V];wt(e.width,e.height+e.depth),vn[e.path](e);var r=new Image;return r[ct]=u[ut](),wt(t,n),r}function pn(e,t,n,r,i,s){a.beginPath(),a.rect(e,t,n,r),a.fillStyle=i,a.fill(),a.closePath()}function dn(e,t,n,r,i,s,o){a.beginPath(),a.moveTo(e,t),a.lineTo(i,s),a.lineTo(n,r),a.closePath(),a.fillStyle=o,a.fill(),a.closePath()}function mn(){if(l!==null)return l;if(l===null){var e=gn();if(e)return l=H[e.x][e.y],l}return!1}function gn(){for(var e=0;e<H[tt];e++)for(var t=0;t<H[e][tt];t++)if(H[e][t][W]==="base")return{"x":e,"y":t};return!1}function yn(e){Tt(l,e.health);if(l.health<1){bn(l.x,l.y),l=null;var t=mn();t||Bt()}}function bn(e,t){var n=H[e][t],r=Lt(t,d),i=r-n.height/2,s=r+n.height,o=Lt(e,d),u=o+gt-n.width/2,a=o+n.width,f=[];for(var l=0;l<n.colors.length;l++){var c=n.colors[l];f.push(bt(c.red,c.green,c.blue))}lr(20,50,[2,7],[-2,2,-2,2],[u,i,a,s],f,!0),H[e][t]=0}function wn(e,t){k++;var n=H[e][t],r=n.cost+n.cost*(n.level-1)*2*.25;rr(r),bn(e,t)}function En(){var e=On().cost;m=null,rr(e)}function Sn(e,t,n){return Et(z[e.weapon])}function xn(e,t){if(Tn()){C++;var n=H[e][t];ir(kn(n)),n.level++,wr(n)}}function Tn(){return w&&nr>=kn(w)?!0:!1}function Nn(e,t){var n=H[e][t];nr<Ln(n)?(n.health+=nr/10,ir(nr)):nr>=Ln(n)&&(ir(Ln(n)),n.health=n.fullHealth),L++}function Cn(){return w&&nr>=Ln(w)?!0:!1}function kn(e){return e.cost*e.level*2}function Ln(e){return(e.fullHealth-e.health)*5}function An(){return On()?!0:!1}function On(){return m===at?!1:Ot(B,W,m)[0]}function Mn(e){if(JSON.stringify(g)!==S||e){S=JSON.stringify(g),r.body.style.cursor="default";if(xt(H)!==0)return r.body.style.cursor="pointer",x=null,at;if(!An())return x=!0,!0;var t=$t(g.x,g.y);if(Jt(t).indexOf(!0)===-1)return x=!1,!1;if(q[tt]){var n=Ot(q,"x",g.x);if(Ot(n,"y",g.y)[tt])return x=!1,!1;var n=Ot(q,"targetX",g.x);if(Ot(n,"targetY",g.y)[tt])return x=!1,!1;var t=$t(g.x,g.y);if(!un(q,t))return x=!1,!1}return On().is==="terrain"?(x=!0,!0):xt(P).type===lt?(x=!0,!0):On().is==="trap"&&xt(P).type==="fast"?(x=!0,!0):(x=!1,!1)}return x}function _n(){r[Y](ft).children[tt]>0&&(r[Y](ft)[G]="");var e=[];for(var t=1;t<B[tt];t++){var n=B[t],i="",s="",o=$+">"+n[W]+Q,u=$+" class='cost'>$"+n.cost+Q,a="<img src='"+n.image.src+"'>",f=J+" data-name='"+n.name+"' class='container"+i+s+"' title='"+n.is+": "+n[W]+" ($"+n.cost+")"+"'>"+a+o+u+K;e.push(""+f+"")}r[Y](ft)[G]=e.join(""),In()}function Pn(e){this.content=[],this.scoreFunction=e}function Hn(){Bn(),f=requestAnimationFrame(Hn)}function Bn(){wt(h*d,p*d),Vt()}function jn(){r[Y]("loadingText")[ot].add("hidden"),r[Y]("message")[ot].remove("hidden")}function Fn(){r[Y]("loading")[ot].add("hidden"),Hn()}function In(){var e=r[et](".container");for(var t=0;t<e[tt];t++)Jn(e[t],"click",Rn)}function qn(e){e.preventDefault()}function Rn(e){qn(e);var t=this;!t[ot].contains("expensive")&&!An()&&(w=null,m=t.getAttribute("data-name"),ir(Ot(B,W,m)[0].cost))}function Un(e){qn(e),(l.x!==g.x||l.y!==g.y)&&wn(w.x,w.y),w=null}function zn(e){qn(e),(l.x!==g.x||l.y!==g.y)&&xn(w.x,w.y)}function Wn(e){qn(e),(l.x!==g.x||l.y!==g.y)&&Nn(w.x,w.y)}function Xn(e){qn(e),w=null;if(An()&&Mn())if(e.which===2)En();else{N++;var t=Et(On(),["x","y","weapon"],[zt,Wt,Sn],[g.x,g.y]);H[g.x][g.y]=t,w=H[g.x][g.y],m=null,sr(),q.length&&an(q)}Mn()===null&&(e.which===2?(l.x!==g.x||l.y!==g.y)&&wn(g.x,g.y):H[g.x][g.y]===0?w=null:w=H[g.x][g.y])}function Vn(e){g.x=e.pageX-u.offsetLeft,g.y=e.pageY-u.offsetTop,g.x=Mt(g.x,d),g.y=Mt(g.y,d)}function $n(){strokeColor="black",Mn()&&An()?strokeColor="green":Mn()===at?strokeColor="blue":Mn()||(strokeColor="red")}function Jn(e,t,n){Kn(e,t,n),e.addEventListener(t,n,!0)}function Kn(e,t,n){e.removeEventListener(t,n)}function Qn(){var e=g.x*32,t=g.y*32;a.strokeStyle=strokeColor,a.lineWidth=2,a.strokeRect(e,t,32,32),a.strokeStyle="#FFF",a.strokeRect(e-2,t-2,36,36);if(w!==null){var e=w.x*32,t=w.y*32;a.strokeStyle="#FFF",a.lineWidth=2,a.strokeRect(e,t,32,32);if(typeof w.weapon!="string"){a.beginPath(),a.arc(Lt(w.x,1),Lt(w.y,1),w.weapon.range*32,0,2*Math.PI,!1),a.fillStyle="rgba(255,255,255,0.3)",a.fill();var n=w.weapon.range*32-1,r=4*Math.PI,i=2*Math.PI;a.beginPath(),a.arc(Lt(w.x,1),Lt(w.y,1),n,r,i,!1),a.lineWidth=2,a.strokeStyle="rgba(0,0,0,0.3)",a.stroke()}}}function Gn(){Jn(r,"keydown",Yn)}function Yn(e){var t=0;e.keyCode-48>=1&&e.keyCode-48<=5?t=e.keyCode-48:e.keyCode-96>=1&&e.keyCode-96<=5&&(t=e.keyCode-96),w&&(e.keyCode===81&&Wn(e),e.keyCode===87&&zn(e),e.keyCode===69&&Un(e));if(t>0){qn(e);var n=r[et](".container"),i=n[t-1];!i[ot].contains("expensive")&&!An()&&(w=null,m=B[t].name,ir(Ot(B,W,m)[0].cost))}}function Zn(){for(i=0;i<I[tt];i++){var t=I[i];for(e=0;e<t.path.length;e++){var n=t.path[e];a.beginPath(),a.fillStyle="rgba(100,100,100,0.5)",a.fillRect(n.x*d,n.y*d,d,d),a.fill(),a.closePath()}}}function er(){for(i=0;i<I[tt];i++){var t=I[i],n=$t(g.x,g.y),r=getBaseCoords(),s=Dn.search(n,n[t.x][t.y],n[r.x][r.y]);for(e=0;e<s.length;e++){var o=s[e];a.beginPath(),a.fillStyle="rgba(0,255,0,0.5)",a.fillRect(o.x*d,o.y*d,d,d),a.fill(),a.closePath()}}}function tr(){cancelAnimationFrame(f)}function rr(e){nr+=Nt(e),sr()}function ir(e){nr-=Nt(e),O+=e,sr()}function sr(){var e=r[et](".container");for(var t=0;t<e[tt];t++){var n=e[t],i=B[t+1];n[ot].remove("expensive"),n[ot].remove("building"),i.cost>nr&&n[ot].add("expensive"),On()&&n[ot].add("building")}or()}function or(){Tn()?r.getElementById("upgrade").setAttribute("disabled",!0):r.getElementById("upgrade").removeAttribute("disabled")}function ur(){var e=mn().health||0,t="<li>",n="</li>",i="<code>",s="</code>",o=[];o[it]("Base Health: "+i+e+s),o[it]("Wave: "+i+y+s),o[it]("Enemies: "+i+b+s),o[it]("Enemies Remaining: "+i+(j[0].length+q.length)+s),o[it]("money: "+i+nr+s),r[Y]("data")[G]="<ul>"+t+o.join(n+t)+n+"</ul>";var o=[];o[it]("Mouse Position: "+i+g.x+", "+g.y+s),o[it]("Tile: "+i+xt(P).name+s),o[it]("Can Build: "+i+Mn()+s),r[Y]("selection")[G]="<ul>"+t+o.join(n+t)+n+"</ul>";if(w!==null){var o=[];o.push("Name: "+i+w.name+s),o.push("Level: "+i+w.level+s),o.push("Health: "+i+w.health/w.fullHealth*100+"%"+s),o.push("Weapon Stats:"),o.push("Name: "+i+w.weapon.name+s),o.push("Range: "+i+w.weapon.range+s),o.push("Bullets Per Shot: "+i+w.weapon.amount+s),o.push("Delay: "+i+w.weapon.delay+s),o.push("Damage: "+i+w.weapon.damage+s),r[Y]("tower")[G]="<ul>"+t+o.join(n+t)+n+"</ul>",r[Y]("upgrade").value="Upgrade Tower",r[Y]("repair").value="Repair Tower",r[Y]("repair").setAttribute("disabled",!0),r[Y]("sell").setAttribute("disabled",!0),r[Y]("upgrade").setAttribute("disabled",!0),w.name!=="Base"&&(r[Y]("sell").removeAttribute("disabled"),Jn(r[Y]("sell"),"click",Un),r[Y]("upgrade").value="Upgrade Tower ($"+kn(w)+")",Tn()?(r[Y]("upgrade").removeAttribute("disabled"),Jn(r[Y]("upgrade"),"click",zn)):(r[Y]("upgrade").setAttribute("disabled",!0),Kn(r[Y]("upgrade"),"click",zn))),r[Y]("repair").setAttribute("disabled",!0),w.health<w.fullHealth&&(r[Y]("repair").value="Repair Tower ($"+Ln(w)+")",r[Y]("repair").removeAttribute("disabled"),Jn(r[Y]("repair"),"click",Wn))}else r[Y]("tower")[G]="",r[Y]("upgrade").value="Upgrade Tower",r[Y]("repair").value="Repair Tower",r[Y]("upgrade").setAttribute("disabled",!0),r[Y]("sell").setAttribute("disabled",!0),r[Y]("repair").setAttribute("disabled",!0),Kn(r[Y]("sell"),"click",Un),Kn(r[Y]("upgrade"),"click",zn),Kn(r[Y]("repair"),"click",Wn)}function ar(e,t,n,r,i,s,u,a,f,l,c,h){var p=i/3,v=d/60*o(i+p,i-p),m=o(0,h.length-1);return{"x":o(e,n),"y":o(t,r),"w":o(s,u),"h":o(s,u),"dx":_t(a,f),"dy":_t(l,c),"life":v,"lifespan":v,"color":h[m]}}function fr(){for(var e=0;e<R.length;e++){var t=R[e];a.beginPath(),a.fillStyle=t.color,a.fillRect(t.x,t.y,t.w,t.h),a.fill(),a.closePath(),t.life=t.life-1,t.life>0?(t.x=t.x+t.dx,t.y=t.y+t.dy):R.splice(e,1)}}function lr(e,t,n,r,i,s){for(var o=0;o<e;o++)R.push(ar(i[0],i[1],i[2],i[3],t,n[0],n[1],r[0],r[1],r[2],r[3],s))}function cr(e){var t=0,n=e.length;waitForParticles}function hr(){for(var e=0;e<U.length;e++){var t=U[e];if(t.x+t.radius>u.width||t.y+t.radius>u.height||t.x<0||t.y<0)U.splice(e,1);else{var n=yr(t);if(n){U.splice(e,1),Tt(n,t.damage);var r=n.pixelX,i=n.pixelY,s=n.size/2;lr(Ct(t.damage/n.fullHealth*n.size)+1,60,[2,7],[-2,2,-2,2],[r,i-s,r+s,i+s],[bt(n.red,n.green,n.blue),bt(St(n.red),St(n.green),St(n.blue))])}else{a.beginPath(),a.fillStyle="rgba("+t.red+","+t.green+","+t.blue+","+t.life/t.maxLife+")",a.arc(t.x,t.y,t.radius,0,2*Math.PI,!1),a.fill(),a.closePath();if(t.life>0||t.life<0)t.targetX>0&&t.targetY>0?(t.x-=t.speed*t.dx,t.y-=t.speed*t.dy):t.targetX<0&&t.targetY>0?(t.x-=t.speed*t.dx,t.y-=t.speed*t.dy):(t.x+=t.speed*t.dx,t.y+=t.speed*t.dy),t.life--;t.life===0&&U.splice(e,1)}}}}function pr(e,t){var n=e.x-t.x,r=e.y-t.y;return n+r}function dr(e){if(e[0]){var t=e[0],n=pr(l,e[0]);for(var r=1;r<e.length;r++)e[r]&&pr(l,e[r])<n&&(t=e[r],n=pr(l,e[r]));return t}return!1}function vr(e){if(e.weapon.timer>=e.weapon.delay){var t=[],n=Lt(e.x,1),r=Lt(e.y,1,e.size)-e.height,i=e.weapon.range*d;yt(q,function(e){var s=this;mr(n,r,i,s.pixelX,s.pixelY,s.size/2)&&t.push(s)});if(e.weapon.timer>=e.weapon.delay){var s=dr(t);if(s){e.weapon.timer=0;var o=n-s.pixelX,u=r-s.pixelY,a=Math.atan(o/u),f=e.weapon.speed/60*Math.sin(a),l=e.weapon.speed/60*Math.cos(a),c=Math.sqrt(f*f+l*l)/(e.weapon.speed/2),h=s.speed*c;s.targetX>s.x?f+=h:s.targetX<s.x&&(f-=h),s.targetY>s.y?l+=h:s.targetY<s.y&&(l-=h),Er(e,n,r,f,l,o,u)}}}e.weapon.timer++}function mr(e,t,n,r,i,s){var o=e-r,u=t-i,a=n+s;return o*o+u*u<=a*a}function gr(e,t,n,r,i,s,u,a,f,l,c,h,p,d,v){if(e==="cannon")U.push({"radius":i,"x":u,"y":a,"dx":f,"dy":l,"red":c,"green":h,"blue":p,"alpha":d,"life":r,"maxLife":r,"speed":s,"targetX":t,"targetY":n,"damage":v||1});else if(e==="spread")for(var m=0;m<5;m++){var c=o(0,100),h=o(0,100),p=o(100,255);gr("cannon",t,n,25,3,s,u,a,_t(f-f/2,f+f/2),_t(l-l/2,l+l/2),c,h,p,d,2)}else if(e==="beam")U.push({"radius":i,"x":u,"y":a,"dx":_t(f-f/2,f+f/2),"dy":_t(l-l/2,l+l/2),"red":c,"green":h,"blue":p,"alpha":d,"life":1e3,"maxLife":100,"speed":20,"targetX":t,"targetY":n,"damage":1});else if(e==="explode")for(var m=0;m<25;m++)U.push({"radius":i,"x":u,"y":a,"dx":_t(-2,2)/60,"dy":_t(-2,2)/60,"red":c,"green":h,"blue":p,"alpha":d,"life":35,"maxLife":35,"speed":120,"targetX":t,"targetY":n,"damage":5})}function yr(e){for(var t=0;t<q.length;t++){var n=q[t];if(mr(n.pixelX,n.pixelY,n.size/2,e.x,e.y,e.radius))return n}return!1}function br(e,t,n,r,i,s,o,u,a,f){z[e]={"name":e,"radius":u,"amount":t,"directionFunction":f,"x":null,"y":null,"dx":null,"dy":null,"level":1,"red":a.red,"green":a.green,"blue":a.blue,"alpha":1,"life":o,"maxLife":o,"speed":n,"targetX":null,"targetY":null,"range":s,"delay":i,"timer":0,"damage":r||1}}function wr(e){if(e.level!==e.weapon.level){if(e.weapon.name==="spread"||e.weapon.name==="gatling"||e.weapon.name==="explode")var t=function(t){return t+e.level};else var t=function(e){return e};var n=function(e){return e};e.weapon=Sr(e.weapon,{"amount":t,"range":function(t){return t+e.level*.5},"life":function(t){return t+e.level*10},"maxLife":function(t){return t+e.level*10},"damage":function(t){return t+e.level},"delay":function(t){return t-e.level>-1?t-e.level:0},"speed":n})}}function Er(e,t,n,r,i,s,o){for(var u=0;u<e.weapon.amount;u++){var a=Et(e.weapon);U.push(Sr(a,{"x":t,"y":n,"dx":e.weapon.directionFunction(r),"dy":e.weapon.directionFunction(i),"targetX":s,"targetY":o}))}}function Sr(e,t){for(var r in t)e[r]!==n&&(typeof t[r]=="function"?e[r]=t[r](z[e.name][r]):e[r]=t[r]);return e}var r=t.document,u,a,f=null,l=null,c=0,h=26,p=26,d=32,v=0,m=null,g={"x":0,"y":0},y=1,b=0,w=null,E=!1,S="",x=!0,T=0,N=0,C=0,k=0,L=0,A=0,O=0,M=[],_=[],D=[],P=[],H=[],B=[],j=[],F=[],B=[],I=[],q=[],R=[],U=[],z={},W="name",X="width",V="height",$="<span",J="<div",K="</div>",Q="</span>",G="innerHTML",Y="getElementById",Z="querySelector",et=Z+"All",tt="length",nt="floor",rt="Math",it="push",st="rgb(",ot="classList",ut="toDataURL",at=null,ft="towers",lt="path",ct="src",ht="cost",pt="next",dt="color",vt="speed",mt=t,gt=d/2;mt.addEventListener("DOMContentLoaded",function(){Ht(),_n(),Xt(h,p),rr(500),Jn(u,"mousemove",Vn),Jn(u,"mousedown",Xn),Jn(u,"contextmenu",qn),Jn(r.getElementById("startGame"),"click",Fn),Jn(r.getElementById("nextWave"),"click",fn),Jn(r.getElementById("nextWave"),"click",fn),jn(),Gn()});var vn={"triangle":function(e){var t=e.x,n=e.y,r=e.depth,i=e.width,s=e.height,o=i/2,u=e.colors;dn(o+t,n,t,n+s,t+o,n+s+r,bt(u[0].red,u[0].green,u[0].blue)),dn(o+t-1,n,o+t-1,n+s+r,t+i,n+s,bt(u[1].red,u[1].green,u[1].blue))},"rectangle":function(e){var t=e.colors;pn(e.x,e.y+e.depth/2,e.width,e.height,bt(t[0].red,t[0].green,t[0].blue)),pn(e.x,e.y,e.width,e.depth,bt(t[1].red,t[1].green,t[1].blue))}},Dn={"init":function(e){for(var t=0,n=e[tt];t<n;t++)for(var r=0,i=e[t][tt];r<i;r++){var s=e[t][r];s.f=0,s.g=0,s.h=0,s[ht]=s[vt],s.visited=!1,s.closed=!1,s.parent=at}},"heap":function(){return new Pn(function(e){return e.f})},"search":function(e,t,n){Dn.init(e),heuristic=Dn.manhattan;var r=Dn.heap();r[it](t);while(r.size()>0){var i=r.pop();if(i===n){var s=i,o=[];while(s.parent)o[it](s),s=s.parent;return o.reverse()}i.closed=!0;var u=Dn.neighbors(e,i);for(var a=0,f=u[tt];a<f;a++){var l=u[a];if(l.closed||l[vt]===0)continue;var c=i.g+l[ht],h=l.visited;if(!h||c<l.g)l.visited=!0,l.parent=i,l.h=l.h||heuristic(l.x,l.y,n.x,n.y),l.g=c,l.f=l.g+l.h,h?r.rescoreElement(l):r[it](l)}}return[]},"manhattan":function(e,t,n,r){var i=mt[rt].abs(n-e),s=mt[rt].abs(r-t);return i+s},"neighbors":function(e,t){var n=[],r=t.x,i=t.y;return e[r-1]&&e[r-1][i]&&n[it](e[r-1][i]),e[r+1]&&e[r+1][i]&&n[it](e[r+1][i]),e[r]&&e[r][i-1]&&n[it](e[r][i-1]),e[r]&&e[r][i+1]&&n[it](e[r][i+1]),n}};Pn.prototype={"push":function(e){this.content[it](e),this.sinkDown(this.content[tt]-1)},"pop":function(){var e=this.content[0],t=this.content.pop();return this.content[tt]>0&&(this.content[0]=t,this.bubbleUp(0)),e},"size":function(){return this.content[tt]},"rescoreElement":function(e){this.sinkDown(this.content.indexOf(e))},"sinkDown":function(e){var t=this.content[e];while(e>0){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},"bubbleUp":function(e){var t=this.content[tt],n=this.content[e],r=this.scoreFunction(n);for(;;){var i=e+1<<1,s=i-1,o=at;if(s<t){var u=this.content[s],a=this.scoreFunction(u);a<r&&(o=s)}if(i<t){var f=this.content[i],l=this.scoreFunction(f);l<(o===at?r:a)&&(o=i)}if(o===at)break;this.content[e]=this.content[o],this.content[o]=n,e=o}}};var nr=0;(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t[tt]&&!mt.requestAnimationFrame;++n)mt.requestAnimationFrame=mt[t[n]+"RequestAnimationFrame"],mt.cancelAnimationFrame=mt[t[n]+"CancelAnimationFrame"]||mt[t[n]+"CancelRequestAnimationFrame"];mt.requestAnimationFrame||(mt.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=mt[rt].max(0,16-(r-e)),s=mt.setTimeout(function(){t(r+i)},i);return e=r+i,s}),mt.cancelAnimationFrame||(mt.cancelAnimationFrame=function(e){clearTimeout(e)})})(),typeof r!="undefined"&&!("classList"in r.createElement("a"))&&function(e){"use strict";var t="classList",n="prototype",r=(e.HTMLElement||e.Element)[n],i=Object,s=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(e){var t=0,n=this.length;for(;t<n;t++)if(t in this&&this[t]===e)return t;return-1},u=function(e,t){this.name=e,this.code=DOMException[e],this.message=t},a=function(e,t){if(t==="")throw new u("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(t))throw new u("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(e,t)},f=function(e){var t=s.call(e.className),n=t?t.split(/\s+/):[],r=0,i=n.length;for(;r<i;r++)this.push(n[r]);this._updateClassName=function(){e.className=this.toString()}},l=f[n]=[],c=function(){return new f(this)};u[n]=Error[n],l.item=function(e){return this[e]||null},l.contains=function(e){return e+="",a(this,e)!==-1},l.add=function(e){e+="",a(this,e)===-1&&(this.push(e),this._updateClassName())},l.remove=function(e){e+="";var t=a(this,e);t!==-1&&(this.splice(t,1),this._updateClassName())},l.toggle=function(e){e+="",a(this,e)===-1?this.add(e):this.remove(e)},l.toString=function(){return this.join(" ")};if(i.defineProperty){var h={"get":c,"enumerable":!0,"configurable":!0};try{i.defineProperty(r,t,h)}catch(p){p.number===-2146823252&&(h.enumerable=!1,i.defineProperty(r,t,h))}}else i[n].__defineGetter__&&r.__defineGetter__(t,c)}(self);var xr={}})(window)