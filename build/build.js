(function(e,t){function M(e){var t=e instanceof Array?[]:{};for(i in e){if(i==="clone")continue;e[i]&&typeof e[i]=="object"&&!Array.isArray(e[i])&&!e[i].nodeType?t[i]=M(e[i]):t[i]=e[i]}return t}function _(e,t,n,r){var i=[];for(var s in e)e[s][t]===n&&(r?i[y](M(e[s])):i[y](e[s]));return i.length?i:!1}function D(e,t){return Ut(O[g].random()*(t-e+1))+e}function P(){z=n[h]("canvas"),z[s]=I*R,z[o]=q*R,W=z.getContext("2d")}function H(){var e=0;for(var t=0;t<Z[v];t++)e+=Z[t].priority;var n=D(0,e-1);for(var t=0;t<Z[v];t++){if(n<Z[t].priority)return t;n-=Z[t].priority}return!1}function B(e,t){e.health-=t}function j(e,t){var n=e%t;return(e-n)/t}function F(e){for(var t=0;t<et.length;t++)et[t][r]===e&&et.splice(t,1)}function nt(){var e=n[d](".container");for(var t=0;t<e[v];t++)ut(e[t],"click",rt)}function rt(e){var t=this;t[w].contains("expensive")||(Q=t[p]("span").innerText,Jt(_(tt,r,Q)[0].cost))}function it(e){}function st(e){V.x=e.pageX-z.offsetLeft,V.y=e.pageY-z.offsetTop,V.x=j(V.x,R),V.y=j(V.y,R)}function ot(){J="black",pt()&&ct()?J="green":pt()===S?J="blue":pt()||(J="red")}function ut(e,t,n){at(e,t,n),e.addEventListener(t,n,!0)}function at(e,t,n){e.removeEventListener(t,n)}function ft(){var e=V.x*32,t=V.y*32,n=e+32,r=t+32;W.strokeStyle=J,W.lineWidth=2,W.strokeRect(e,t,32,32),W.strokeStyle="#FFF",W.strokeRect(e-2,t-2,36,36)}function lt(){var e=Dt().health,t=["money"],r="<li>",i="</li>",s="<code>",o="</code>",u=[];u[y]("Base Health: "+s+JSON.stringify(e)+o);for(var a=0;a<t[v];a++)typeof this[t[a]]=="function"?u[y](t[a]+": "+s+JSON.stringify(this[t[a]]())+o):u[y](t[a]+": "+s+JSON.stringify(this[t[a]])+o);n[h]("data")[c]="<ul>"+r+u.join(i+r)+i+"</ul>"}function ct(){return ht()?!0:!1}function ht(){return Q===S?!1:_(structures,r,Q)}function pt(){var e=G[V.y][V.x];if(Y[V.y][V.x]!==0)return S;var t=_(et,"y",V.y);return t[v]&&_(t,"x",V.x)[v]?!1:ct()?ht().is==="terrain"?!0:e.is===T?!0:ht().is==="trap"&&e.is==="fast"?!0:!1:!0}function dt(){n[h](x)[c]=""}function vt(){n[h](x).children[v]>0&&dt();var e=[];for(var t=0;t<tt[v];t++){var i=tt[t],s=u+">"+i[r]+l,o=u+" class='cost'>$"+i[C]+l,p="<img src='"+i.image[N]+"'>",d=a+" class='container' title='"+i.is+": "+i[r]+" ($"+i[C]+")"+"'>"+p+s+o+f;e[y](""+d+"")}n[h](x)[c]=e.join(""),nt()}function mt(e,t){for(var n=0;n<t;n++){G[n]=G[n]||[],Y[n]=Y[n]||[];for(var r=0;r<e;r++){var i=H(),s=new Et(Z[i],"imageList");s.x=r,s.y=n,s.pos={"x":r,"y":n},G[n][r]=s,Y[n][r]=0}}var o=D(e/2-1,t/2+1),u=new Ht(tt[0]);return u.x=u.y=o,Y[o][o]=u,[G,Y]}function gt(){for(var e=0;e<G[v];e++)for(var t=0;t<G[e][v];t++)W.drawImage(G[e][t].image,t*32,e*32)}function yt(){for(var e=0;e<G[v];e++)for(var t=0;t<G[e][v];t++)typeof Y[e][t]=="object"&&Lt(Y[e][t],t,e)}function bt(e,t,n,r,i,s,o){var u,a,f=[],l=[];for(var c=0;c<e;c++)f[y](D(0,t-1,e)),l[y](D(0,t-1,e));for(u=0;u<e;u++)a=D(n,r),W.fillStyle=b+Rt(a/i)+","+Rt(a/s)+","+Rt(a/o)+")",W.fillRect(f[u],l[u],1,1)}function wt(e,t,n,r,i,u){var a=[];z[s]=32,z[o]=32;for(var f=0;f<3;f++){num=D(i[0][1],i[0][2]),W.fillStyle=b+Rt(num/i[0][3])+","+Rt(num/i[0][4])+","+Rt(num/i[0][5])+")",W.fillRect(0,0,u,u);for(var l=0;l<i[v];l++)bt(i[l][0],u,i[l][1],i[l][2],i[l][3],i[l][4],i[l][5]);var c=new Image;c[N]=z[E](),a[y](c),W.clearRect(0,0,z[s],z[o])}var h=X;return X++,z[s]=I*u,z[o]=q*u,{"name":e,"is":t,"imageList":a,"images":a[v],"priority":n,"id":h,"speed":r}}function Et(e,t){for(var n in e)n===t?this.image=e[t][D(0,e.images-1)]:this[n]=e[n];return this}function St(){Z[y](wt("grass",T,7,1,[[1024,175,230,1.3,1,2],[50,200,245,1,1.3,1.5],[100,125,175,2,1,2]],32)),Z[y](wt("darkGrass",T,7,1,[[1024,150,205,1.3,1,2],[50,175,220,1,1.3,1.5],[100,100,150,2,1,2]],32)),Z[y](wt("road","speed",4,.5,[[1024,0,0,1,1,1],[600,0,50,1,1,1]],32)),Z[y](wt("water","slow",3,1.5,[[1024,100,200,1.5,1.5,1],[600,100,200,1.5,1.5,1]],32))}function xt(){requestAnimationFrame(xt)}function Tt(){gt(),ot(),ft(),qt(),Wt(),yt(),lt()}function Nt(){n[h]("loading")[w].add("hidden")}function Ct(){var e=[["base","special",1e4,1e3,15,25,255,0,0],["turret","basic",100,10,10,20,200,0,0]];for(var t=0;t<e[v];t++)tt[y](kt(e[t][0],e[t][1],e[t][2],e[t][3],e[t][4],e[t][5],e[t][6],e[t][7],e[t][8]))}function kt(e,t,n,r,i,u,a,f,l){var c=D(i,u),h=D(i,u)+Rt(c/1.5),p=D(i-3,u-3);z[s]=32,z[o]=32,W.clearRect(0,0,z[s],z[o]),_t(0,0,c,h,p,a,l,f);var d=new Image;return d[N]=z[E](),z[s]=I*R,z[o]=q*R,{"name":e,"is":t,"cost":n,"health":r,"color":[a,l,f],"image":d,"width":c,"height":h,"depth":p}}function Lt(e,t,n){e.x=t,e.y=n,_t(R*t+(U-e[s]/2),R*n-e[o]+U,e[s],e[o],e.depth,e[L][0],e[L][1],e[L][2])}function At(e){return e-50<0?e:e-50}function Ot(e,t,n,r,i,s,o){W.beginPath(),W.rect(e,t,n,r),W.fillStyle=b+i+","+s+","+o+")",W.fill()}function Mt(){var e=new Image;e[N]=z[E](),images[y](e)}function _t(e,t,n,r,i,s,o,u){Ot(e,t+i/2,n,r,s,u,o),Ot(e,t,n,i,At(s),At(u),At(o))}function Dt(){for(var e=0;e<Y[v];e++)for(var t=0;t<Y[e][v];t++)if(Y[e][t][r]==="base")return Y[e][t];return!1}function Pt(){for(var e=0;e<Y[v];e++)for(var t=0;t<Y[e][v];t++)if(Y[e][t][r]==="base")return{"x":t,"y":e};return!1}function Ht(e,t){var n=Object.create(null);for(var r in e)n[r]=e[r];return n}function Bt(e){B(Dt(),e.health)}function jt(){var e=[];et[y](It("Scoot","normal","FFF000",12,1,125,e))}function Ft(e,t,n){for(var r=0;r<n[v];r++)if(n[r][0]===e&&n[r][1]===t)return!1;return!0}function It(e,t,n,r,i,s,o){var u=D(0,3),a=0,f=0;do if(u===0||u===2)a=D(0,I-1),u===2&&(f=I-1);else if(u===1||u===3)f=D(0,q-1),u===1&&(a=q-1);while(!Ft(a,f,o));o[y]([a,f]);var l=R/60*i,c=Pt(),h=Xt.search(G,G[f][a],G[c.y][c.x]);return{"name":e,"type":t,"color":n,"size":r,"speed":l,"health":s,"targetX":h[0].x,"targetY":h[0].y,"path":h,"x":a,"y":f,"pixelX":zt(a,r),"pixelY":zt(f,r),"pathIndex":0}}function qt(){if(et[v])for(i=0;i<et[v];i++){var e=et[i];W.beginPath(),W.fillStyle=e[L],W.fillRect(e.pixelX,e.pixelY,e.size,e.size),W.fill()}}function Rt(e){return O[g].round(e)}function Ut(e){return O[g][m](e)}function zt(e,t){return Rt(e*R+U-t/2)}function Wt(){for(var e=0;e<et.length;e++){var t=et[e];if(t.pathIndex<t[T][v]){var n=t[T][t.pathIndex];t.x=j(t.pixelX+t.size/2,R),t.y=j(t.pixelY+t.size/2,R),t.targetX=n.x,t.targetY=n.y;var i=G[t.y][t.x],s=t[A]/i[A],o=zt(t.targetX,t.size),u=zt(t.targetY,t.size);Rt(t.pixelX)<o?t.pixelX+s>o?t.pixelX=o:t.pixelX+=s:Rt(t.pixelY)<u?t.pixelY+s>u?t.pixelY=u:t.pixelY+=s:Rt(t.pixelX)>o?t.pixelX-s<o?t.pixelX=o:t.pixelX-=s:Rt(t.pixelY)>u&&(t.pixelY-s<u?t.pixelY=u:t.pixelY-=s),Rt(t.pixelX)===zt(t.targetX,t.size)&&Rt(t.pixelY)===zt(t.targetY,t.size)&&t.pathIndex++}else Bt(t),F(t[r])}}function Vt(e){this.content=[],this.scoreFunction=e}function $t(e){K+=e,Kt()}function Jt(e){K-=e,Kt()}function Kt(){var e=n[d](".container");for(var t=0;t<e[v];t++){e[t][w].remove("expensive");var r=e[t][p](".cost").innerText.substring(1);parseInt(r,10)>K&&e[t][w].add("expensive")}}function Yt(){this.position=Qt.create(),this.direction=Qt.create(),this.size=0,this.sizeSmall=0,this.timeToLive=0,this.colour=[],this.drawColour="",this.deltaColour=[],this.sharpness=40}function Zt(){this.maxParticles=23,this.particles=[],this.active=!0,this.position=Qt.create(325,180),this.positionRandom=Qt.create(0,10),this.size=9,this.sizeRandom=13,this.speed=5,this.speedRandom=1.5,this.lifeSpan=9,this.lifeSpanRandom=7,this.angle=0,this.angleRandom=360,this.gravity=Qt.create(.1,1),console.log(this.gravity),this.startColour=[250,218,68,1],this.startColourRandom=[62,60,60,0],this.finishColour=[245,0,0,0],this.finishColourRandom=[21,21,8,0],this.sharpness=40,this.sharpnessRandom=17,this.particleCount=0,this.elapsedTime=0,this.duration=10,this.emissionRate=20,this.emitCounter=0,this.particleIndex=0,this.init=function(){this.emissionRate=this.maxParticles/this.lifeSpan,this.emitCounter=0},this.addParticle=function(){if(this.particleCount==this.maxParticles)return!1;var e=new Yt;return this.initParticle(e),this.particles[this.particleCount]=e,this.particleCount++,!0},this.initParticle=function(e){var t=function(){return Math.random()*2-1};e.position.x=this.position.x+this.positionRandom.x*t(),e.position.y=this.position.y+this.positionRandom.y*t();var n=(this.angle+this.angleRandom*t())*(Math.PI/180),r=Qt.create(Math.cos(n),Math.sin(n)),i=this.speed+this.speedRandom*t();e.direction=Qt.multiply(r,i),e.size=this.size+this.sizeRandom*t(),e.size=e.size<0?0:~~e.size,e.timeToLive=this.lifeSpan+this.lifeSpanRandom*t(),e.sharpness=this.sharpness+this.sharpnessRandom*t(),e.sharpness=e.sharpness>100?100:e.sharpness<0?0:e.sharpness,e.sizeSmall=~~(e.size/200*e.sharpness);var s=[this.startColour[0]+this.startColourRandom[0]*t(),this.startColour[1]+this.startColourRandom[1]*t(),this.startColour[2]+this.startColourRandom[2]*t(),this.startColour[3]+this.startColourRandom[3]*t()],o=[this.finishColour[0]+this.finishColourRandom[0]*t(),this.finishColour[1]+this.finishColourRandom[1]*t(),this.finishColour[2]+this.finishColourRandom[2]*t(),this.finishColour[3]+this.finishColourRandom[3]*t()];e.colour=s,e.deltaColour[0]=(o[0]-s[0])/e.timeToLive,e.deltaColour[1]=(o[1]-s[1])/e.timeToLive,e.deltaColour[2]=(o[2]-s[2])/e.timeToLive,e.deltaColour[3]=(o[3]-s[3])/e.timeToLive},this.update=function(e){if(this.active&&this.emissionRate>0){var t=1/this.emissionRate;this.emitCounter+=e;while(this.particleCount<this.maxParticles&&this.emitCounter>t)this.addParticle(),this.emitCounter-=t;this.elapsedTime+=e,this.duration!=-1&&this.duration<this.elapsedTime&&this.stopParticleEmitter()}this.particleIndex=0;while(this.particleIndex<this.particleCount){var n=this.particles[this.particleIndex];if(n.timeToLive>0){n.direction=Qt.add(n.direction,this.gravity),n.position=Qt.add(n.position,n.direction),n.timeToLive-=e;var r=n.colour[0]+=n.deltaColour[0]*e,i=n.colour[1]+=n.deltaColour[1]*e,s=n.colour[2]+=n.deltaColour[2]*e,o=n.colour[3]+=n.deltaColour[3]*e,u=[];u.push("rgba("+(r>255?255:r<0?0:~~r)),u.push(i>255?255:i<0?0:~~i),u.push(s>255?255:s<0?0:~~s),u.push((o>1?1:o<0?0:o.toFixed(2))+")"),n.drawColour=u.join(","),this.particleIndex++}else this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]),this.particleCount--}},this.stopParticleEmitter=function(){this.active=!1,this.elapsedTime=0,this.emitCounter=0},this.renderParticles=function(e){for(var t=0,n=this.particleCount;t<n;t++){var r=this.particles[t],i=r.size,s=i>>1,o=~~r.position.x,u=~~r.position.y,a=e.createRadialGradient(o+s,u+s,r.sizeSmall,o+s,u+s,s);a.addColorStop(0,r.drawColour),a.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=a,e.fillRect(o,u,i,i)}}}var n=e.document,r="name",s="width",o="height",u="<span",a="<div",f="</div>",l="</span>",c="innerHTML",h="getElementById",p="querySelector",d=p+"All",v="length",m="floor",g="Math",y="push",b="rgb(",w="classList",E="toDataURL",S=null,x="towers",T="path",N="src",C="cost",k="next",L="color",A="speed",O=e;(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t[v]&&!O.requestAnimationFrame;++n)O.requestAnimationFrame=O[t[n]+"RequestAnimationFrame"],O.cancelAnimationFrame=O[t[n]+"CancelAnimationFrame"]||O[t[n]+"CancelRequestAnimationFrame"];O.requestAnimationFrame||(O.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=O[g].max(0,16-(r-e)),s=O.setTimeout(function(){t(r+i)},i);return e=r+i,s}),O.cancelAnimationFrame||(O.cancelAnimationFrame=function(e){clearTimeout(e)})})(),O.addEventListener("DOMContentLoaded",function(){P(),St(),Ct(),vt();var e=mt(I,q);G=e[0],Y=e[1],$t(500),jt(),xt(),Nt()});var I=20,q=20,R=32,U=R/2,z,W,X=0,V={"x":0,"y":0},J="black",K=0,Q=S,G=[],Y=[],Z=[],et=[],tt=[];O.addEventListener("DOMContentLoaded",function(){ut(z,"mousemove",st),ut(z,"click",it)},!0),Et.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},Et.prototype.isWall=function(){return this.type===0};var Xt={"init":function(e){for(var t=0,n=e[v];t<n;t++)for(var r=0,i=e[r][v];r<i;r++){var s=e[t][r];s.f=0,s.g=0,s.h=0,s[C]=s[A],s.visited=!1,s.closed=!1,s.parent=S}},"heap":function(){return new Vt(function(e){return e.f})},"search":function(e,t,n){Xt.init(e),heuristic=Xt.manhattan;var r=Xt.heap();r[y](t);while(r.size()>0){var i=r.pop();if(i===n){var s=i,o=[];while(s.parent)o[y](s),s=s.parent;return o.reverse()}i.closed=!0;var u=Xt.neighbors(e,i);for(var a=0,f=u[v];a<f;a++){var l=u[a];if(l.closed||l.isWall())continue;var c=i.g+l[C],h=l.visited;if(!h||c<l.g)l.visited=!0,l.parent=i,l.h=l.h||heuristic(l.pos,n.pos),l.g=c,l.f=l.g+l.h,h?r.rescoreElement(l):r[y](l)}}return[]},"manhattan":function(e,t){var n=O[g].abs(t.x-e.x),r=O[g].abs(t.y-e.y);return n+r},"neighbors":function(e,t){var n=[],r=t.x,i=t.y;return e[i-1]&&e[i-1][r]&&n[y](e[i-1][r]),e[i+1]&&e[i+1][r]&&n[y](e[i+1][r]),e[i]&&e[i][r-1]&&n[y](e[i][r-1]),e[i]&&e[i][r+1]&&n[y](e[i][r+1]),n}};Vt.prototype={"push":function(e){this.content[y](e),this.sinkDown(this.content[v]-1)},"pop":function(){var e=this.content[0],t=this.content.pop();return this.content[v]>0&&(this.content[0]=t,this.bubbleUp(0)),e},"size":function(){return this.content[v]},"rescoreElement":function(e){this.sinkDown(this.content.indexOf(e))},"sinkDown":function(e){var t=this.content[e];while(e>0){var n=(e+1>>1)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},"bubbleUp":function(e){var t=this.content[v],n=this.content[e],r=this.scoreFunction(n);for(;;){var i=e+1<<1,s=i-1,o=S;if(s<t){var u=this.content[s],a=this.scoreFunction(u);a<r&&(o=s)}if(i<t){var f=this.content[i],l=this.scoreFunction(f);l<(o===S?r:a)&&(o=i)}if(o===S)break;this.content[e]=this.content[o],this.content[o]=n,e=o}}};var K=0,Qt={"create":function(e,t){return{"x":e||-1,"y":t||-1}},"multiply":function(e,t){return e.x*=t,e.y*=t,e},"add":function(e,t){return e.x+=t.x,e.y+=t.y,e}},Gt={"canvas":null,"context":null,"intro":0,"curIntro":2,"xSpeed":0,"doSin":!1,"sinOff":321.25,"blendMode":1,"blendModes":["source-over","lighter","darker","xor"],"eg":[[2,23,9,13,0,10,40,17,9,7,5,1.5,0,360,1,0,250,144,35,1,32,31,25,0,245,0,0,0,21,21,8,0,1]],"schemaVersion":2,"init":function(){this.canvas=n.getElementById("canvas");if(!this.canvas.getContext){alert("Sorry cobber, no Canvas support in yo' browser...");return}this.context=this.canvas.getContext("2d"),this.setBlendMode(this.blendMode),this.pe=new Zt,this.pe.init(),this.main()},"main":function(){this.update(),this.draw(),requestAnimationFrame(function(){Gt.main()})},"update":function(){this.setExample(++this.curIntro%this.eg.length),this.pe.update(1);if(this.doSin){this.sinOff+=this.xSpeed,this.sinOff=this.sinOff%360;var e=Math.PI/180;this.pe.position.y=180-Math.sin(e*this.sinOff*3)*180,this.pe.position.x=300-Math.cos(e*this.sinOff)*300}},"draw":function(){this.context.clearRect(0,0,690,452),this.pe.renderParticles(this.context)},"setBlendMode":function(e){this.blendMode=e,this.context.globalCompositeOperation=this.blendModes[e>=0&&e<this.blendModes.length?e:0]},"setExample":function(e){var t=this.eg[0];t[0]!=this.schemaVersion&&(t=this.updateSchema(t))},"getExample":function(){var e=[];return e.push(Gt.schemaVersion),$(".ctrlSlider").each(function(){e.push($(this).slider("option","value"))}),e.join(",")},"loadExample":function(e){var t=this.arrayify(e);if(typeof t=="string"){alert(t);return}this.setExample(t)},"updateSchema":function(e){if(e.length<1||e[0]==this.schemaVersion)return e;switch(e[0]){case 1:e.push(1),e[0]=2}return e},"arrayify":function(e){var t=e.match(/[0-9,\.-]{20,}/);if(t.length!==1)return"sorry, couldn't load";var n=this.updateSchema(t[0].split(","));for(var r=0;r<n.length;r++){var i=parseInt(n[r],10);if(isNaN(i))return"Sorry, couldn't load. Some elements weren't numbers!";n[r]=i}return n[0]!=this.schemaVersion&&(n=this.updateSchema(n)),n.length!=this.eg[0].length?"Sorry, couldn't load. Not the right number of data elements.\n\nYou passed in "+n.length+" but I need "+this.eg[0].length+".":n}};Gt.init()})(window)